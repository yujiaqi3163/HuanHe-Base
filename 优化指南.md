# AI é—²é±¼ç´ æåº“ - éƒ¨ç½²å‰ä¼˜åŒ–æŒ‡å—

**æœ€åæ›´æ–°**: 2026-02-22  
**é¡¹ç›®çŠ¶æ€**: âœ… åŠŸèƒ½å¼€å‘å®Œæˆï¼Œå¯ä»¥éƒ¨ç½²ï¼Œå»ºè®®æŒ‰ä¼˜å…ˆçº§ä¼˜åŒ–

---

## ä¸€ã€å¿«é€Ÿå¼€å§‹ï¼šéƒ¨ç½²å‰å¿…é¡»åšçš„ 3 ä»¶äº‹

### 1.1 å¼ºåˆ¶ HTTPSï¼ˆğŸ”´ é«˜ä¼˜å…ˆçº§ï¼‰

åœ¨ `app/__init__.py` çš„ `Config` ç±»ä¸­æ·»åŠ ï¼š

```python
# åœ¨ Config ç±»ä¸­æ·»åŠ 
if not os.environ.get('FLASK_ENV') == 'development':
    SESSION_COOKIE_SECURE = True
    SESSION_COOKIE_HTTPONLY = True
    REMEMBER_COOKIE_SECURE = True
```

åœ¨ç”Ÿäº§ç¯å¢ƒçš„ Nginx é…ç½®ä¸­å¼ºåˆ¶ HTTPSï¼š

```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # å…¶ä»–é…ç½®...
}
```

### 1.2 é…ç½® Gunicornï¼ˆğŸ”´ é«˜ä¼˜å…ˆçº§ï¼‰

åˆ›å»º `gunicorn_config.py`ï¼š

```python
import multiprocessing

bind = "127.0.0.1:5000"
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "sync"
timeout = 120
keepalive = 5
accesslog = "logs/access.log"
errorlog = "logs/error.log"
loglevel = "info"
```

åˆ›å»º `requirements.txt` æ·»åŠ ç”Ÿäº§ä¾èµ–ï¼š

```
gunicorn>=21.0.0
```

å¯åŠ¨å‘½ä»¤ï¼š
```bash
gunicorn -c gunicorn_config.py app:app
```

### 1.3 æ–‡ä»¶ä¸Šä¼ é™åˆ¶ï¼ˆğŸ”´ é«˜ä¼˜å…ˆçº§ï¼‰

åœ¨ `app/__init__.py` çš„ `Config` ç±»ä¸­æ·»åŠ ï¼š

```python
# æœ€å¤§ä¸Šä¼ æ–‡ä»¶å¤§å° 10MB
MAX_CONTENT_LENGTH = 10 * 1024 * 1024
```

åœ¨æ–‡ä»¶ä¸Šä¼ å¤„ç†å‡½æ•°ä¸­æ·»åŠ ç™½åå•éªŒè¯ï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰ï¼š

```python
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'webp'}

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS
```

---

## äºŒã€æ ¸å¿ƒå®‰å…¨åŠ å›ºï¼ˆå¿…é¡»é˜…è¯»ï¼‰

### 2.1 å·²æœ‰çš„å®‰å…¨æªæ–½ âœ…

| å®‰å…¨é¡¹ | çŠ¶æ€ | ä½ç½® |
|--------|------|------|
| CSRF ä¿æŠ¤ | âœ… å·²å¯ç”¨ | `WTF_CSRF_ENABLED = True` |
| å¯†ç å¼ºåº¦éªŒè¯ | âœ… å·²å®ç° | 8ä½+ã€å¤§å°å†™ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ |
| Cookie HttpOnly | âœ… å·²é…ç½® | é»˜è®¤å¼€å¯ |
| SQL æ³¨å…¥é˜²æŠ¤ | âœ… æœ‰æ•ˆ | ä½¿ç”¨ SQLAlchemy ORM |
| ç¯å¢ƒå˜é‡å¯†é’¥ | âœ… å·²å®ç° | `.env` æ–‡ä»¶ç®¡ç† |
| éªŒè¯ç é™æµ | âœ… å·²æ·»åŠ  | 3æ¬¡/60ç§’ |
| è®¾å¤‡é”æœºåˆ¶ | âœ… å·²å®ç° | å•è®¾å¤‡ç™»å½• |
| æ“ä½œæ—¥å¿— | âœ… å®Œå–„ | æ‰€æœ‰æ“ä½œæœ‰è®°å½• |

### 2.2 å¿«é€Ÿå®‰å…¨æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰ç¡®è®¤ï¼š

- [ ] `DEBUG=False`ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰
- [ ] `.env` æ–‡ä»¶ä¸æäº¤åˆ° Git
- [ ] `SECRET_KEY` æ˜¯å¼ºéšæœºå­—ç¬¦ä¸²
- [ ] æ•°æ®åº“æ–‡ä»¶æƒé™æ­£ç¡®ï¼ˆä»…åº”ç”¨å¯è¯»å†™ï¼‰
- [ ] æ—¥å¿—ç›®å½•æƒé™æ­£ç¡®
- [ ] ä¸Šä¼ ç›®å½•æ²¡æœ‰æ‰§è¡Œæƒé™

---

## ä¸‰ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 3.1 N+1 æŸ¥è¯¢ä¼˜åŒ–ï¼ˆå·²éªŒè¯ âœ…ï¼‰

é¡¹ç›®ä¸­å·²å‘ç° N+1 æŸ¥è¯¢é—®é¢˜ï¼Œåœ¨æŸ¥è¯¢ç´ æåˆ—è¡¨æ—¶ä½¿ç”¨ `joinedload` é¢„åŠ è½½ï¼š

**ä¼˜åŒ–å‰ï¼ˆé—®é¢˜ä»£ç ï¼‰**ï¼š
```python
materials = Material.query.order_by(Material.created_at.desc()).limit(10).all()
for material in materials:
    cover_image = next((img for img in material.images if img.is_cover), None)
    material_type_name = material.material_type.name if material.material_type else 'æœªåˆ†ç±»'
    # æ¯æ¬¡å¾ªç¯éƒ½ä¼šå‘èµ·æ–°æŸ¥è¯¢ï¼
```

**ä¼˜åŒ–å**ï¼š
```python
from sqlalchemy.orm import joinedload

materials = Material.query.options(
    joinedload(Material.images),
    joinedload(Material.material_type)
).order_by(Material.created_at.desc()).limit(10).all()
```

### 3.2 DeepSeek API å¼‚æ­¥å¤„ç†ï¼ˆğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼‰

**é—®é¢˜**ï¼š`app/utils/material_remix.py:16` çš„ `optimize_copywriting` æ˜¯åŒæ­¥è°ƒç”¨ï¼Œä¼šé˜»å¡ Flask worker

**æ¨èæ–¹æ¡ˆ**ï¼šä½¿ç”¨ Celery + Redisï¼ˆé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰

ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–
```bash
pip install celery redis
```

ç¬¬äºŒæ­¥ï¼šåˆ›å»º `app/tasks.py`
```python
from celery import Celery
from app.utils.material_remix import optimize_copywriting

celery = Celery('tasks', broker='redis://localhost:6379/0')

@celery.task
def async_optimize_copywriting(original_text):
    return optimize_copywriting(original_text)
```

ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹äºŒåˆ›æ¥å£ï¼Œç«‹å³è¿”å›ä»»åŠ¡ID
```python
from app.tasks import async_optimize_copywriting

@bp.route('/api/material/<int:id>/remix', methods=['POST'])
@login_required
def api_remix_material(id):
    # ... è·å–ç´ æ ...
    task = async_optimize_copywriting.delay(material.description)
    return jsonify({
        'success': True,
        'task_id': task.id,
        'message': 'æ–‡æ¡ˆä¼˜åŒ–ä¸­ï¼Œè¯·ç¨åæŸ¥çœ‹ç»“æœ'
    })
```

ç¬¬å››æ­¥ï¼šæ·»åŠ æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€çš„æ¥å£
```python
@bp.route('/api/task/<task_id>', methods=['GET'])
@login_required
def api_get_task_status(task_id):
    from app.tasks import async_optimize_copywriting
    task = async_optimize_copywriting.AsyncResult(task_id)
    if task.state == 'SUCCESS':
        return jsonify({'success': True, 'state': 'SUCCESS', 'result': task.result})
    elif task.state == 'FAILURE':
        return jsonify({'success': False, 'state': 'FAILURE', 'error': str(task.result)})
    else:
        return jsonify({'success': True, 'state': task.state})
```

### 3.3 Redis åˆ†å¸ƒå¼é™æµï¼ˆğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼‰

å½“å‰ `app/utils/rate_limit.py` ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œå¤šè¿›ç¨‹éƒ¨ç½²æ—¶å¤±æ•ˆã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šä½¿ç”¨ Redis ZSET å®ç°

ä¿®æ”¹ `app/utils/rate_limit.py`ï¼š
```python
from functools import wraps
from flask import request, jsonify
from datetime import datetime, timedelta
import redis
import logging

logger = logging.getLogger(__name__)

# å°è¯•è¿æ¥ Redisï¼Œå¤±è´¥åˆ™é™çº§åˆ°å†…å­˜
try:
    redis_client = redis.Redis(host='localhost', port=6379, db=0, decode_responses=True)
    redis_client.ping()
    USE_REDIS = True
except:
    USE_REDIS = False
    rate_limit_records = {}

def rate_limit(key_prefix, max_requests=5, time_window=60):
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            from flask_login import current_user
            if current_user and current_user.is_authenticated:
                user_identifier = f"user_{current_user.id}"
            else:
                user_identifier = f"ip_{request.remote_addr}"
            
            rate_key = f"{key_prefix}_{user_identifier}"
            now = datetime.now()
            now_ts = now.timestamp()
            
            if USE_REDIS:
                # Redis å®ç°ï¼ˆåŸå­æ“ä½œï¼‰
                pipe = redis_client.pipeline()
                pipe.zremrangebyscore(rate_key, 0, now_ts - time_window)
                pipe.zcard(rate_key)
                pipe.zadd(rate_key, {now_ts: now_ts})
                pipe.expire(rate_key, time_window + 10)
                _, count, _, _ = pipe.execute()
                
                if count >= max_requests:
                    return jsonify({
                        'success': False,
                        'message': f'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•ï¼ˆé™åˆ¶{max_requests}æ¬¡/{time_window}ç§’ï¼‰'
                    }), 429
            else:
                # é™çº§åˆ°å†…å­˜å­˜å‚¨
                global rate_limit_records
                if rate_key in rate_limit_records:
                    rate_limit_records[rate_key] = [
                        t for t in rate_limit_records[rate_key] 
                        if now - t < timedelta(seconds=time_window)
                    ]
                if rate_key not in rate_limit_records:
                    rate_limit_records[rate_key] = []
                if len(rate_limit_records[rate_key]) >= max_requests:
                    return jsonify({
                        'success': False,
                        'message': f'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•ï¼ˆé™åˆ¶{max_requests}æ¬¡/{time_window}ç§’ï¼‰'
                    }), 429
                rate_limit_records[rate_key].append(now)
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator
```

---

## å››ã€éƒ¨ç½²æ£€æŸ¥æ¸…å•

### 4.1 éƒ¨ç½²å‰ï¼ˆå¿…åšï¼‰

- [ ] å®Œæˆ 1.1-1.3 çš„é«˜ä¼˜å…ˆçº§ä¼˜åŒ–
- [ ] è®¾ç½® `DEBUG=False`
- [ ] é…ç½® HTTPS
- [ ] é…ç½® Gunicorn
- [ ] é…ç½® Nginxï¼ˆå¯é€‰ä½†æ¨èï¼‰
- [ ] å¤‡ä»½æ•°æ®åº“
- [ ] ç¡®è®¤æ‰€æœ‰ç¯å¢ƒå˜é‡æ­£ç¡®é…ç½®
- [ ] æµ‹è¯•ç™»å½•ã€æ³¨å†Œã€ç´ æä¸Šä¼ ç­‰æ ¸å¿ƒåŠŸèƒ½

### 4.2 éƒ¨ç½²åéªŒè¯

- [ ] é¦–é¡µæ­£å¸¸åŠ è½½
- [ ] ç”¨æˆ·å¯ä»¥æ³¨å†Œ/ç™»å½•
- [ ] è®¾å¤‡é”æ­£å¸¸å·¥ä½œ
- [ ] ç´ ææµè§ˆ/æœç´¢æ­£å¸¸
- [ ] ç´ æä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- [ ] ç´ æäºŒåˆ›åŠŸèƒ½æ­£å¸¸ï¼ˆåŒ…æ‹¬ API è¶…æ—¶é™çº§ï¼‰
- [ ] ç®¡ç†åå°æƒé™æ­£å¸¸
- [ ] æ‰¹é‡åˆ é™¤ã€å…¨éƒ¨åˆ é™¤åŠŸèƒ½æ­£å¸¸
- [ ] æ—¥å¿—æ­£å¸¸è®°å½•

---

## äº”ã€é¡¹ç›®ç°çŠ¶è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **å®‰å…¨æ€§** | â­â­â­â­ (4.5/5) | æ ¸å¿ƒå®‰å…¨æªæ–½å®Œå–„ï¼Œå»ºè®®ç”Ÿäº§ç¯å¢ƒåŠ  HTTPS |
| **æ€§èƒ½** | â­â­â­ (3/5) | å½“å‰å¯ç”¨ï¼Œå»ºè®®ä¼˜å…ˆå¤„ç† API é˜»å¡é—®é¢˜ |
| **é²æ£’æ€§** | â­â­â­â­ (4/5) | è¾¹ç•Œæ¡ä»¶å¤„ç†è¾ƒå¥½ï¼Œæœ‰é™çº§æ–¹æ¡ˆ |
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­ (4/5) | ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ¨¡å—åŒ–å¥½ |

---

## å…­ã€æ€»ç»“

**å½“å‰çŠ¶æ€**ï¼šâœ… å¯ä»¥éƒ¨ç½²ï¼Œä½†å¼ºçƒˆå»ºè®®å…ˆå®Œæˆé«˜ä¼˜å…ˆçº§ä¼˜åŒ–

**æ¨èéƒ¨ç½²ç­–ç•¥**ï¼š
1. å…ˆå®Œæˆé«˜ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆHTTPSã€Gunicornã€æ–‡ä»¶é™åˆ¶ï¼‰
2. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
3. ç›‘æ§è¿è¡Œæƒ…å†µ
4. é€æ­¥å®Œæˆä¸­ä½ä¼˜å…ˆçº§ä¼˜åŒ–

**é£é™©æ§åˆ¶**ï¼š
- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰å…ˆåœ¨é¢„å‘å¸ƒç¯å¢ƒéªŒè¯
- å‡†å¤‡å›æ»šæ–¹æ¡ˆ
- é…ç½®å®Œå–„çš„æ—¥å¿—å’Œç›‘æ§

---

**å¦‚æœ‰é—®é¢˜ï¼Œå‚è€ƒ**ï¼š
- `éƒ¨ç½²æŒ‡å—.md` - è¯¦ç»†éƒ¨ç½²æ­¥éª¤
- `æµ‹è¯•ä¸åˆ†ææŠ¥å‘Š.md` - å®Œæ•´æµ‹è¯•åˆ†æ
- `éƒ¨ç½²å‰å…¨é¢æµ‹è¯•ä¸ä¼˜åŒ–å»ºè®®.md` - æ›´è¯¦ç»†çš„æµ‹è¯•æ–¹æ¡ˆ

