# ğŸ“š é¡¹ç›®åŠŸèƒ½å®Œæ•´è¯´æ˜æ–‡æ¡£

> æœ¬æ–‡æ¡£é¢å‘ç¼–ç¨‹æ–°æ‰‹ï¼Œè¯¦ç»†ä»‹ç»é¡¹ç›®çš„æ‰€æœ‰åŠŸèƒ½ã€å®‰å…¨é˜²æŠ¤å’ŒæŠ€æœ¯å®ç°

---

## ğŸ“‚ ä¸€ã€é¡¹ç›®æ•´ä½“ç»“æ„

```
my_flask_app/
â”œâ”€â”€ app/                          # æ ¸å¿ƒåº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ __init__.py               # åº”ç”¨åˆå§‹åŒ–æ–‡ä»¶ï¼ˆFlask å·¥å‚å‡½æ•°ï¼‰
â”‚   â”œâ”€â”€ decorators.py             # è£…é¥°å™¨ï¼ˆæƒé™éªŒè¯ã€è®¾å¤‡é”ç­‰ï¼‰
â”‚   â”œâ”€â”€ forms/                    # è¡¨å•å®šä¹‰ï¼ˆWTFormsï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ admin.py              # ç®¡ç†åå°è¡¨å•
â”‚   â”‚   â”œâ”€â”€ auth.py               # è®¤è¯ç›¸å…³è¡¨å•ï¼ˆç™»å½•ã€æ³¨å†Œç­‰ï¼‰
â”‚   â”‚   â””â”€â”€ material_type.py      # ç´ æåˆ†ç±»è¡¨å•
â”‚   â”œâ”€â”€ models/                   # æ•°æ®æ¨¡å‹ï¼ˆæ•°æ®åº“è¡¨å®šä¹‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py               # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ material.py           # ç´ ææ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ material_image.py     # ç´ æå›¾ç‰‡æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ material_type.py      # ç´ æåˆ†ç±»æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user_material.py      # ç”¨æˆ·äºŒåˆ›ç´ ææ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ register_secret.py    # æ³¨å†Œå¡å¯†æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ terminal_secret.py    # ç»ˆç«¯å¡å¯†æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ permission.py         # æƒé™æ¨¡å‹
â”‚   â”‚   â””â”€â”€ config.py             # é…ç½®æ¨¡å‹
â”‚   â”œâ”€â”€ routes/                   # è·¯ç”±ï¼ˆURL æ¥å£ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth/                 # è®¤è¯ç›¸å…³è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ routes.py         # ç™»å½•ã€æ³¨å†Œã€æ‰¾å›å¯†ç ç­‰
â”‚   â”‚   â”œâ”€â”€ admin/                # ç®¡ç†åå°è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ routes.py         # ç´ æç®¡ç†ã€ç”¨æˆ·ç®¡ç†ç­‰
â”‚   â”‚   â””â”€â”€ main/                 # ä¸»é¡µé¢è·¯ç”±
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ routes.py         # é¦–é¡µã€ç´ æè¯¦æƒ…ã€æˆ‘çš„ç´ æç­‰
â”‚   â”œâ”€â”€ static/                   # é™æ€æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”‚   â””â”€â”€ output.css        # ç¼–è¯‘åçš„ Tailwind CSS
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â””â”€â”€ input.css         # Tailwind æºæ–‡ä»¶
â”‚   â”œâ”€â”€ templates/                # HTML æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ base.html             # åŸºç¡€æ¨¡æ¿ï¼ˆæ‰€æœ‰é¡µé¢ç»§æ‰¿ï¼‰
â”‚   â”‚   â”œâ”€â”€ auth/                 # è®¤è¯é¡µé¢
â”‚   â”‚   â”œâ”€â”€ admin/                # ç®¡ç†åå°é¡µé¢
â”‚   â”‚   â””â”€â”€ main/                 # ç”¨æˆ·é¡µé¢
â”‚   â”œâ”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ logger.py             # æ—¥å¿—å·¥å…·
â”‚   â”‚   â”œâ”€â”€ rate_limit.py         # API é™æµå·¥å…·
â”‚   â”‚   â””â”€â”€ material_remix.py     # ç´ æäºŒåˆ›å·¥å…·ï¼ˆè°ƒç”¨ DeepSeek APIï¼‰
â”‚   â””â”€â”€ tasks.py                  # Celery å¼‚æ­¥ä»»åŠ¡
â”œâ”€â”€ scripts/                      # è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ init_database.py          # åˆå§‹åŒ–æ•°æ®åº“
â”‚   â”œâ”€â”€ create_super_admin.py     # åˆ›å»ºè¶…çº§ç®¡ç†å‘˜
â”‚   â”œâ”€â”€ add_permissions.py        # æ·»åŠ æƒé™
â”‚   â”œâ”€â”€ migrate_*.py              # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚   â”œâ”€â”€ security_penetration_test.py  # å®‰å…¨æ¸—é€æµ‹è¯•
â”‚   â””â”€â”€ performance_concurrency_test.py # æ€§èƒ½å‹åŠ›æµ‹è¯•
â”œâ”€â”€ celery_config.py              # Celery é…ç½®ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
â”œâ”€â”€ requirements.txt              # Python ä¾èµ–åŒ…
â”œâ”€â”€ .env.example                  # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .gitignore                    # Git å¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ run.py                        # é¡¹ç›®å¯åŠ¨æ–‡ä»¶
â””â”€â”€ tailwind.config.js            # Tailwind CSS é…ç½®
```

---

## ğŸ” äºŒã€ç”¨æˆ·è®¤è¯ä¸å®‰å…¨åŠŸèƒ½

### 2.1 ç™»å½•åŠŸèƒ½
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/auth/routes.py` - åç«¯æ¥å£
- `app/forms/auth.py` - ç™»å½•è¡¨å•éªŒè¯
- `app/templates/auth/login.html` - å‰ç«¯é¡µé¢

**åŠŸèƒ½è¯´æ˜ï¼š**
- ç”¨æˆ·è¾“å…¥é‚®ç®±å’Œå¯†ç ç™»å½•
- å¯†ç ä½¿ç”¨ `werkzeug.security` åŠ å¯†å­˜å‚¨ï¼ˆbcrypt ç®—æ³•ï¼‰
- ç™»å½•æˆåŠŸåä¿å­˜ sessionï¼Œ30 å¤©å†…å…ç™»å½•
- æ”¯æŒè®°ä½å¯†ç åŠŸèƒ½

**å®‰å…¨ç‰¹æ€§ï¼š**
- âœ… å¯†ç åŠ ç›å“ˆå¸Œå­˜å‚¨ï¼ˆé˜²æ˜æ–‡å­˜å‚¨ï¼‰
- âœ… ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
- âœ… CSRF é˜²æŠ¤ï¼ˆFlask-WTFï¼‰

---

### 2.2 æ³¨å†ŒåŠŸèƒ½
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/auth/routes.py`
- `app/forms/auth.py`
- `app/templates/auth/register.html`

**åŠŸèƒ½è¯´æ˜ï¼š**
- éœ€è¦è¾“å…¥æ³¨å†Œå¡å¯†æ‰èƒ½æ³¨å†Œ
- å¡å¯†éªŒè¯é€šè¿‡åæ‰èƒ½åˆ›å»ºè´¦å·
- é‚®ç®±æ ¼å¼éªŒè¯
- å¯†ç å¼ºåº¦éªŒè¯ï¼ˆé•¿åº¦ã€å¤æ‚åº¦ï¼‰

**å®‰å…¨ç‰¹æ€§ï¼š**
- âœ… å¡å¯†éªŒè¯ï¼ˆé˜²æ­¢éšæ„æ³¨å†Œï¼‰
- âœ… é‚®ç®±æ ¼å¼å’Œå¯é€è¾¾æ€§éªŒè¯
- âœ… å¯†ç ç¡®è®¤ï¼ˆä¸¤æ¬¡è¾“å…¥ä¸€è‡´ï¼‰

---

### 2.3 æ‰¾å›å¯†ç åŠŸèƒ½
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/auth/routes.py`
- `app/templates/auth/forgot_password.html`

**åŠŸèƒ½è¯´æ˜ï¼š**
- é€šè¿‡é‚®ç®±éªŒè¯ç é‡ç½®å¯†ç 
- å‘é€éªŒè¯ç åˆ°æ³¨å†Œé‚®ç®±
- éªŒè¯ç æœ‰æ•ˆæœŸé™åˆ¶

**å®‰å…¨ç‰¹æ€§ï¼š**
- âœ… é‚®ç®±éªŒè¯ç éªŒè¯
- âœ… éªŒè¯ç è¿‡æœŸæœºåˆ¶

---

### 2.4 è®¾å¤‡é”åŠŸèƒ½
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/decorators.py` - `@device_required` è£…é¥°å™¨
- `app/routes/auth/routes.py` - è®¾å¤‡ç»‘å®šæ¥å£
- `app/models/user.py` - è®¾å¤‡ ID å­—æ®µ

**åŠŸèƒ½è¯´æ˜ï¼š**
- è´¦å·é¦–æ¬¡ç™»å½•æ—¶ç»‘å®šå½“å‰è®¾å¤‡
- åç»­ç™»å½•å¿…é¡»ä½¿ç”¨åŒä¸€è®¾å¤‡
- è¶…çº§ç®¡ç†å‘˜ä¸å—è®¾å¤‡é”é™åˆ¶
- æ”¯æŒç”³è¯·è§£ç»‘è®¾å¤‡

**å·¥ä½œåŸç†ï¼š**
1. ç”¨æˆ·ç™»å½•æ—¶ï¼Œå‰ç«¯ç”Ÿæˆå”¯ä¸€çš„è®¾å¤‡ IDï¼ˆå­˜å‚¨åœ¨ Cookie ä¸­ï¼‰
2. å¦‚æœæ˜¯é¦–æ¬¡ç™»å½•ï¼Œå°†è®¾å¤‡ ID ä¿å­˜åˆ°æ•°æ®åº“
3. åç»­ç™»å½•æ—¶ï¼ŒéªŒè¯ Cookie ä¸­çš„è®¾å¤‡ ID æ˜¯å¦ä¸æ•°æ®åº“ä¸€è‡´
4. ä¸ä¸€è‡´åˆ™å¼ºåˆ¶é€€å‡º

**å®‰å…¨ç‰¹æ€§ï¼š**
- âœ… é˜²æ­¢è´¦å·å¤šè®¾å¤‡åŒæ—¶ç™»å½•
- âœ… è®¾å¤‡ ID åŠ å¯†å­˜å‚¨
- âœ… è¶…çº§ç®¡ç†å‘˜è±å…ï¼ˆæ–¹ä¾¿ç®¡ç†ï¼‰

---

## ğŸ‘¨â€ğŸ’¼ ä¸‰ã€ç”¨æˆ·ä¸ªäººä¸­å¿ƒåŠŸèƒ½

### 3.1 ä¸ªäººèµ„æ–™ç®¡ç†
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/main/routes.py`
- `app/templates/main/profile_edit.html`

**åŠŸèƒ½è¯´æ˜ï¼š**
- ä¿®æ”¹ç”¨æˆ·å
- ä¿®æ”¹æ€§åˆ«
- æŸ¥çœ‹å’Œç¼–è¾‘ä¸ªäººä¿¡æ¯

---

### 3.2 å®‰å…¨ä¸­å¿ƒ
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/main/routes.py`
- `app/templates/main/security_center.html`

**åŠŸèƒ½æ¨¡å—ï¼š**
1. **ä¿®æ”¹å¯†ç ** (`security_password.html`)
   - éªŒè¯æ—§å¯†ç 
   - è®¾ç½®æ–°å¯†ç 
   
2. **è®¾å¤‡ç®¡ç†** (`security_device.html`)
   - æŸ¥çœ‹å½“å‰ç»‘å®šè®¾å¤‡
   - ç”³è¯·è§£ç»‘è®¾å¤‡
   
3. **å¡å¯†ç®¡ç†** (`security_secret.html`)
   - æŸ¥çœ‹æ³¨å†Œå¡å¯†ä¿¡æ¯

---

## ğŸ¨ å››ã€ç´ æç®¡ç†åŠŸèƒ½

### 4.1 ç´ ææµè§ˆ
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/main/routes.py` - é¦–é¡µè·¯ç”±
- `app/templates/main/index.html` - é¦–é¡µ

**åŠŸèƒ½è¯´æ˜ï¼š**
- æŸ¥çœ‹æ‰€æœ‰å·²ä¸Šæ¶çš„ç´ æ
- æ”¯æŒåˆ†ç±»ç­›é€‰
- ç´ æå¡ç‰‡å±•ç¤ºï¼ˆå°é¢å›¾ã€æ ‡é¢˜ã€æè¿°ï¼‰

---

### 4.2 ç´ æè¯¦æƒ…
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/main/routes.py` - è¯¦æƒ…é¡µè·¯ç”±
- `app/templates/main/material_detail.html` - è¯¦æƒ…é¡µ

**åŠŸèƒ½è¯´æ˜ï¼š**
- æŸ¥çœ‹ç´ æå®Œæ•´å†…å®¹
- æŸ¥çœ‹æ‰€æœ‰å›¾ç‰‡ï¼ˆè½®æ’­å±•ç¤ºï¼‰
- ç‚¹å‡»"äºŒåˆ›"æŒ‰é’®è¿›è¡Œç´ æäºŒæ¬¡åˆ›ä½œ

---

### 4.3 ç´ æäºŒåˆ›ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼ï¼‰
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/main/routes.py` - `/api/material/<id>/remix` æ¥å£
- `app/tasks.py` - `async_remix_material` å¼‚æ­¥ä»»åŠ¡
- `app/utils/material_remix.py` - DeepSeek API è°ƒç”¨
- `app/templates/main/material_detail.html` - å‰ç«¯äºŒåˆ›æŒ‰é’®

**åŠŸèƒ½è¯´æ˜ï¼š**
1. ç”¨æˆ·ç‚¹å‡»"äºŒåˆ›"æŒ‰é’®
2. åç«¯ç«‹å³è¿”å› task_idï¼ˆä¸é˜»å¡ï¼‰
3. Celery å¼‚æ­¥ä»»åŠ¡åœ¨åå°å¤„ç†ï¼š
   - è°ƒç”¨ DeepSeek API ä¼˜åŒ–æ–‡æ¡ˆ
   - ç”Ÿæˆä¸é‡å¤çš„ CSS æ··åˆé…æ–¹
   - åˆ›å»ºç”¨æˆ·äºŒåˆ›ç´ æè®°å½•
   - å¤åˆ¶å¹¶å¤„ç†å›¾ç‰‡
4. å‰ç«¯æ¯ 2 ç§’è½®è¯¢ä»»åŠ¡çŠ¶æ€
5. ä»»åŠ¡å®Œæˆåè‡ªåŠ¨åˆ·æ–°é¡µé¢

**æŠ€æœ¯äº®ç‚¹ï¼š**
- âš¡ **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨ Celery + Redisï¼Œä¸é˜»å¡ç”¨æˆ·æ“ä½œ
- ğŸ¤– **AI ä¼˜åŒ–**ï¼šè°ƒç”¨ DeepSeek API æ™ºèƒ½æ”¹å†™æ–‡æ¡ˆ
- ğŸ¨ **CSS æ··åˆ**ï¼šè‡ªåŠ¨ç”Ÿæˆå›¾ç‰‡å¤„ç†é…æ–¹

**ç›¸å…³æ–‡ä»¶ï¼š**
- `celery_config.py` - Celery é…ç½®
- `.env` - DeepSeek API Key é…ç½®

---

### 4.4 æˆ‘çš„ç´ æ
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/main/routes.py`
- `app/templates/main/my_materials.html`

**åŠŸèƒ½è¯´æ˜ï¼š**
- æŸ¥çœ‹è‡ªå·±äºŒåˆ›çš„æ‰€æœ‰ç´ æ
- ç‚¹å‡»è¿›å…¥è¯¦æƒ…é¡µ
- æŸ¥çœ‹ç´ ææµè§ˆå’Œä¸‹è½½æ¬¡æ•°

---

## ğŸ› ï¸ äº”ã€ç®¡ç†åå°åŠŸèƒ½

### 5.1 ç´ æç®¡ç†
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/admin/routes.py`
- `app/templates/admin/admin_materials.html`

**åŠŸèƒ½åˆ—è¡¨ï¼š**
1. **ç´ æåˆ—è¡¨**
   - æŸ¥çœ‹æ‰€æœ‰ç´ æ
   - æ˜¾ç¤ºç´ ææ€»æ•°
   
2. **æ‰¹é‡åˆ é™¤**
   - å‹¾é€‰å¤šä¸ªç´ æåˆ é™¤
   - åˆ é™¤åŒæ—¶åˆ é™¤å›¾ç‰‡æ–‡ä»¶
   
3. **å…¨éƒ¨åˆ é™¤**
   - ä¸€é”®æ¸…ç©ºç´ æåº“ï¼ˆæ…é‡ï¼ï¼‰
   
4. **æ·»åŠ ç´ æ**
   - å•ä¸ªç´ ææ·»åŠ 
   - **æ‰¹é‡ä¸Šä¼ **ï¼ˆæ–‡ä»¶å¤¹æ‰¹é‡å¯¼å…¥ï¼‰

---

### 5.2 æ‰¹é‡ä¸Šä¼ ç´ æ
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/admin/routes.py` - `/batch-upload-material` æ¥å£
- `app/templates/admin/admin_material_add.html` - ä¸Šä¼ é¡µé¢

**åŠŸèƒ½è¯´æ˜ï¼š**
- æ”¯æŒé€‰æ‹©æ•´ä¸ªæ–‡ä»¶å¤¹ä¸Šä¼ 
- è‡ªåŠ¨è¯†åˆ«æ–‡ä»¶å¤¹å†…çš„ `æ–‡æ¡ˆ.txt`ï¼ˆæ ¼å¼ï¼š`titleï¼š"..." contentï¼š"..."`ï¼‰
- è‡ªåŠ¨è¯†åˆ«å›¾ç‰‡æ–‡ä»¶ï¼ˆjpgã€pngã€gifã€webpã€bmpï¼‰
- **é€ä¸ªæ–‡ä»¶ä¸Šä¼ **ï¼ˆé˜²æ­¢è¯·æ±‚è¿‡å¤§ï¼‰
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼šå•ä¸ªæ–‡ä»¶æœ€å¤§ 50MB
- æ–‡ä»¶ç±»å‹ç™½åå•éªŒè¯

**å®‰å…¨ç‰¹æ€§ï¼š**
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆé˜²è¶…å¤§æ–‡ä»¶æ”»å‡»ï¼‰
- âœ… æ–‡ä»¶ç±»å‹ç™½åå•ï¼ˆé˜²æ¶æ„æ–‡ä»¶ä¸Šä¼ ï¼‰
- âœ… æ–‡ä»¶åå®‰å…¨å¤„ç†ï¼ˆ`secure_filename`ï¼‰
- âœ… é€ä¸ªä¸Šä¼ å®¹é”™ï¼ˆæŸä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–ï¼‰

---

### 5.3 ç´ æåˆ†ç±»ç®¡ç†
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/admin/routes.py`
- `app/templates/admin/admin_material_types.html`

**åŠŸèƒ½è¯´æ˜ï¼š**
- æ·»åŠ ç´ æåˆ†ç±»
- ç¼–è¾‘åˆ†ç±»åç§°
- åˆ é™¤åˆ†ç±»

---

### 5.4 ç”¨æˆ·ç®¡ç†
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/admin/routes.py`
- `app/templates/admin/admin_users.html`

**åŠŸèƒ½è¯´æ˜ï¼š**
- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
- ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯
- ç¦ç”¨/å¯ç”¨ç”¨æˆ·
- æŸ¥çœ‹ç”¨æˆ·ç»‘å®šçš„è®¾å¤‡

---

### 5.5 æƒé™ç®¡ç†
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/admin/routes.py`
- `app/templates/admin/admin_user_permissions.html`
- `app/models/permission.py` - æƒé™æ¨¡å‹
- `app/decorators.py` - `@permission_required` è£…é¥°å™¨

**åŠŸèƒ½è¯´æ˜ï¼š**
- åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ï¼ˆRBACï¼‰
- ä¸ºç”¨æˆ·åˆ†é…æƒé™
- æƒé™è£…é¥°å™¨éªŒè¯

**ç¤ºä¾‹æƒé™ï¼š**
- `material_manage` - ç´ æç®¡ç†æƒé™
- `user_manage` - ç”¨æˆ·ç®¡ç†æƒé™

---

### 5.6 å¡å¯†ç®¡ç†
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/routes/admin/routes.py`
- `app/templates/admin/admin_secrets.html`

**åŠŸèƒ½è¯´æ˜ï¼š**
- ç”Ÿæˆæ³¨å†Œå¡å¯†
- ç”Ÿæˆç»ˆç«¯å¡å¯†
- æŸ¥çœ‹å¡å¯†ä½¿ç”¨æƒ…å†µ
- ç¦ç”¨/å¯ç”¨å¡å¯†

---

## ğŸ”’ å…­ã€å®‰å…¨é˜²æŠ¤åŠŸèƒ½

### 6.1 SQL æ³¨å…¥é˜²æŠ¤
**å®ç°æ–¹å¼ï¼š**
- ä½¿ç”¨ **Flask-SQLAlchemy** ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰
- ä¸ç›´æ¥æ‹¼æ¥ SQL è¯­å¥
- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢

**ç¤ºä¾‹ä»£ç ï¼š**
```python
# âœ… å®‰å…¨å†™æ³•ï¼ˆORMï¼‰
user = User.query.filter_by(email=email).first()

# âŒ å±é™©å†™æ³•ï¼ˆSQL æ³¨å…¥é£é™©ï¼‰
# user = db.session.execute(f"SELECT * FROM users WHERE email = '{email}'")
```

**ç›¸å…³æ–‡ä»¶ï¼š**
- æ‰€æœ‰ `app/models/*.py` - ä½¿ç”¨ ORM å®šä¹‰æ¨¡å‹
- æ‰€æœ‰ `app/routes/*/routes.py` - ä½¿ç”¨ ORM æŸ¥è¯¢

---

### 6.2 CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ é˜²æŠ¤
**å®ç°æ–¹å¼ï¼š**
- ä½¿ç”¨ **Flask-WTF** æ‰©å±•
- æ‰€æœ‰è¡¨å•è‡ªåŠ¨åŒ…å« CSRF token
- AJAX è¯·æ±‚ä¹Ÿéœ€è¦éªŒè¯ CSRF token

**é…ç½®ä½ç½®ï¼š**
- `app/__init__.py` - `WTF_CSRF_ENABLED = True`

---

### 6.3 XSS è·¨ç«™è„šæœ¬æ”»å‡»é˜²æŠ¤
**å®ç°æ–¹å¼ï¼š**
- ä½¿ç”¨ **Jinja2** æ¨¡æ¿å¼•æ“è‡ªåŠ¨è½¬ä¹‰ HTML
- æ‰€æœ‰ç”¨æˆ·è¾“å…¥åœ¨æ¸²æŸ“æ—¶è‡ªåŠ¨è½¬ä¹‰

**ç¤ºä¾‹ï¼š**
```html
<!-- Jinja2 è‡ªåŠ¨è½¬ä¹‰ï¼Œé˜²æ­¢ XSS -->
<div>{{ user_input }}</div>
```

---

### 6.4 API é™æµï¼ˆé˜²åˆ·æ¥å£ï¼‰
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/utils/rate_limit.py` - `@rate_limit` è£…é¥°å™¨

**åŠŸèƒ½è¯´æ˜ï¼š**
- é™åˆ¶å•ä¸ª IP åœ¨æŒ‡å®šæ—¶é—´å†…çš„è¯·æ±‚æ¬¡æ•°
- é˜²æ­¢æ¶æ„åˆ·æ¥å£

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```python
@bp.route('/api/login', methods=['POST'])
@rate_limit('login', max_requests=5, time_window=60)  # 1åˆ†é’Ÿæœ€å¤š5æ¬¡
def login():
    pass
```

---

### 6.5 å¯†ç å®‰å…¨
**å®ç°æ–¹å¼ï¼š**
- ä½¿ç”¨ **werkzeug.security** çš„ `generate_password_hash` å’Œ `check_password_hash`
- è‡ªåŠ¨åŠ ç›å“ˆå¸Œï¼ˆbcrypt ç®—æ³•ï¼‰

**ä»£ç ä½ç½®ï¼š**
- `app/models/user.py`

---

### 6.6 æ–‡ä»¶ä¸Šä¼ å®‰å…¨
**å®ç°æ–¹å¼ï¼š**
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ100MB Flask å±‚é¢ï¼Œ50MB ä¸šåŠ¡å±‚é¢ï¼‰
- æ–‡ä»¶ç±»å‹ç™½åå•ï¼ˆä»…å…è®¸å›¾ç‰‡æ ¼å¼ï¼‰
- æ–‡ä»¶åå®‰å…¨å¤„ç†ï¼ˆ`secure_filename`ï¼‰
- æ–‡ä»¶å­˜å‚¨åœ¨é web å¯è®¿é—®ç›®å½•ï¼ˆæˆ–éªŒè¯è®¿é—®æƒé™ï¼‰

**é…ç½®ä½ç½®ï¼š**
- `app/__init__.py` - `MAX_CONTENT_LENGTH = 100 * 1024 * 1024`
- `app/routes/admin/routes.py` - `MAX_FILE_SIZE = 50 * 1024 * 1024`

---

### 6.7 ç¯å¢ƒå˜é‡ä¿æŠ¤
**å®ç°æ–¹å¼ï¼š**
- æ•æ„Ÿä¿¡æ¯ï¼ˆSECRET_KEYã€æ•°æ®åº“å¯†ç ã€API Keyï¼‰å­˜å‚¨åœ¨ `.env` æ–‡ä»¶
- `.env` æ–‡ä»¶åŠ å…¥ `.gitignore`ï¼Œä¸æäº¤åˆ° Git
- ä½¿ç”¨ `python-dotenv` åŠ è½½ç¯å¢ƒå˜é‡

**ç›¸å…³æ–‡ä»¶ï¼š**
- `.env.example` - ç¯å¢ƒå˜é‡ç¤ºä¾‹ï¼ˆå¯æäº¤ï¼‰
- `.env` - å®é™…ç¯å¢ƒå˜é‡ï¼ˆä¸æäº¤ï¼‰
- `.gitignore` - å¿½ç•¥ `.env` æ–‡ä»¶

---

## âš¡ ä¸ƒã€å¼‚æ­¥å¤„ç†åŠŸèƒ½

### 7.1 Celery + Redis å¼‚æ­¥ä»»åŠ¡
**æ–‡ä»¶ä½ç½®ï¼š**
- `celery_config.py` - Celery é…ç½®
- `app/tasks.py` - å¼‚æ­¥ä»»åŠ¡å®šä¹‰
- `app/__init__.py` - Celery åˆå§‹åŒ–

**åŠŸèƒ½è¯´æ˜ï¼š**
- ä½¿ç”¨ **Redis** ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆBrokerï¼‰å’Œç»“æœå­˜å‚¨ï¼ˆBackendï¼‰
- **Celery Worker** åœ¨åå°å¤„ç†è€—æ—¶ä»»åŠ¡
- ä¸é˜»å¡ Flask ä¸»è¿›ç¨‹ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

**å½“å‰å¼‚æ­¥ä»»åŠ¡ï¼š**
1. **ç´ æäºŒåˆ›** (`async_remix_material`)
   - è°ƒç”¨ DeepSeek APIï¼ˆå¯èƒ½è€—æ—¶å‡ ç§’åˆ°å‡ åç§’ï¼‰
   - å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
   - ä»»åŠ¡è¶…æ—¶é™åˆ¶ï¼ˆ300 ç§’ï¼‰

**å¯åŠ¨å‘½ä»¤ï¼ˆLinuxï¼‰ï¼š**
```bash
# å¯åŠ¨ Celery Worker
celery -A celery_config worker --loglevel=info --concurrency=4

# åå°è¿è¡Œ
celery -A celery_config worker --loglevel=info --detach --logfile=celery.log
```

---

## ğŸ“Š å…«ã€æ—¥å¿—åŠŸèƒ½

### 8.1 åº”ç”¨æ—¥å¿—
**æ–‡ä»¶ä½ç½®ï¼š**
- `app/utils/logger.py` - æ—¥å¿—é…ç½®

**åŠŸèƒ½è¯´æ˜ï¼š**
- ä½¿ç”¨ Python æ ‡å‡† `logging` æ¨¡å—
- æ—¥å¿—æŒ‰å¤§å°æ»šåŠ¨ï¼ˆ`RotatingFileHandler`ï¼‰
- åŒæ—¶è¾“å‡ºåˆ°æ–‡ä»¶å’Œæ§åˆ¶å°
- ä¸åŒçº§åˆ«æ—¥å¿—ï¼ˆDEBUGã€INFOã€WARNINGã€ERRORï¼‰

**æ—¥å¿—å†…å®¹ï¼š**
- ç”¨æˆ·ç™»å½•/ç™»å‡º
- ç´ ææ“ä½œï¼ˆæ·»åŠ ã€åˆ é™¤ã€äºŒåˆ›ï¼‰
- API è¯·æ±‚
- é”™è¯¯å¼‚å¸¸

---

## ğŸ—„ï¸ ä¹ã€æ•°æ®åº“æ¨¡å‹

### 9.1 ç”¨æˆ·è¡¨ (`users`)
**æ–‡ä»¶ï¼š** `app/models/user.py`

**å­—æ®µï¼š**
- `id` - ç”¨æˆ· IDï¼ˆä¸»é”®ï¼‰
- `email` - é‚®ç®±ï¼ˆå”¯ä¸€ï¼‰
- `password_hash` - å¯†ç å“ˆå¸Œ
- `username` - ç”¨æˆ·å
- `gender` - æ€§åˆ«
- `bound_device_id` - ç»‘å®šçš„è®¾å¤‡ ID
- `is_super_admin` - æ˜¯å¦è¶…çº§ç®¡ç†å‘˜
- `created_at` - åˆ›å»ºæ—¶é—´

---

### 9.2 ç´ æè¡¨ (`materials`)
**æ–‡ä»¶ï¼š** `app/models/material.py`

**å­—æ®µï¼š**
- `id` - ç´ æ IDï¼ˆä¸»é”®ï¼‰
- `title` - æ ‡é¢˜
- `description` - æè¿°
- `material_type_id` - åˆ†ç±» IDï¼ˆå¤–é”®ï¼‰
- `is_published` - æ˜¯å¦ä¸Šæ¶
- `view_count` - æµè§ˆæ¬¡æ•°
- `created_at` - åˆ›å»ºæ—¶é—´

---

### 9.3 ç´ æå›¾ç‰‡è¡¨ (`material_images`)
**æ–‡ä»¶ï¼š** `app/models/material_image.py`

**å­—æ®µï¼š**
- `id` - å›¾ç‰‡ IDï¼ˆä¸»é”®ï¼‰
- `material_id` - ç´ æ IDï¼ˆå¤–é”®ï¼‰
- `image_url` - å›¾ç‰‡ URL
- `is_cover` - æ˜¯å¦å°é¢
- `sort_order` - æ’åº

---

### 9.4 ç”¨æˆ·äºŒåˆ›ç´ æè¡¨ (`user_materials`)
**æ–‡ä»¶ï¼š** `app/models/user_material.py`

**å­—æ®µï¼š**
- `id` - äºŒåˆ›ç´ æ IDï¼ˆä¸»é”®ï¼‰
- `user_id` - ç”¨æˆ· IDï¼ˆå¤–é”®ï¼‰
- `original_material_id` - åŸå§‹ç´ æ IDï¼ˆå¤–é”®ï¼‰
- `title` - æ ‡é¢˜
- `description` - äºŒåˆ›åæ–‡æ¡ˆ
- `original_description` - åŸå§‹æ–‡æ¡ˆ
- `view_count` - æµè§ˆæ¬¡æ•°
- `download_count` - ä¸‹è½½æ¬¡æ•°
- `created_at` - åˆ›å»ºæ—¶é—´

---

## ğŸ“ åã€é…ç½®æ–‡ä»¶

### 10.1 `.env` ç¯å¢ƒå˜é‡
**å¿…éœ€é…ç½®ï¼š**
```env
# Flask å¯†é’¥ï¼ˆå¿…éœ€ï¼ï¼‰
SECRET_KEY=your_strong_random_secret_key_here

# DeepSeek APIï¼ˆç´ æäºŒåˆ›å¿…éœ€ï¼‰
DEEPSEEK_API_KEY=your_deepseek_api_key
DEEPSEEK_API_BASE=https://api.deepseek.com

# é‚®ç®± SMTPï¼ˆæ‰¾å›å¯†ç å¿…éœ€ï¼‰
MAIL_USERNAME=your_email@163.com
MAIL_PASSWORD=your_email_authorization_code

# Celeryï¼ˆå¼‚æ­¥ä»»åŠ¡å¿…éœ€ï¼‰
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0
```

---

## ğŸš€ åä¸€ã€é¡¹ç›®å¯åŠ¨

### 11.1 å¼€å‘ç¯å¢ƒå¯åŠ¨
```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. åˆå§‹åŒ–æ•°æ®åº“
python scripts/init_database.py

# 3. åˆ›å»ºè¶…çº§ç®¡ç†å‘˜
python scripts/create_super_admin.py

# 4. å¯åŠ¨ Flask å¼€å‘æœåŠ¡å™¨
python run.py
```

### 11.2 ç”Ÿäº§ç¯å¢ƒå¯åŠ¨ï¼ˆLinux + å®å¡”ï¼‰
```bash
# 1. å¯åŠ¨ Redis
sudo systemctl start redis
sudo systemctl enable redis

# 2. å¯åŠ¨ Celery Worker
cd /www/wwwroot/your_project
celery -A celery_config worker --loglevel=info --detach --logfile=celery.log

# 3. ä½¿ç”¨ Gunicorn å¯åŠ¨ Flask
gunicorn -w 4 -b 0.0.0.0:5000 run:app
```

---

## ğŸ“š åäºŒã€å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

### æ–°æ‰‹å¼€å‘è€…ç¬¬ä¸€æ­¥ï¼š
1. **å¤åˆ¶ç¯å¢ƒå˜é‡**
   ```bash
   cp .env.example .env
   # ç„¶åç¼–è¾‘ .envï¼Œå¡«å…¥ä½ çš„é…ç½®
   ```

2. **å®‰è£…ä¾èµ–**
   ```bash
   pip install -r requirements.txt
   ```

3. **åˆå§‹åŒ–æ•°æ®åº“**
   ```bash
   python scripts/init_database.py
   python scripts/create_super_admin.py
   ```

4. **å¯åŠ¨é¡¹ç›®**
   ```bash
   python run.py
   ```

5. **è®¿é—®**
   - å‰å°ï¼šhttp://localhost:5000
   - åå°ï¼šhttp://localhost:5000/admin

---

## ğŸ¯ æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€å®‰å…¨å¯é çš„ Flask ç´ æç®¡ç†ç³»ç»Ÿï¼ŒåŒ…å«ï¼š

| åŠŸèƒ½ç±»åˆ« | ä¸»è¦åŠŸèƒ½ |
|---------|---------|
| **ç”¨æˆ·è®¤è¯** | ç™»å½•ã€æ³¨å†Œã€æ‰¾å›å¯†ç ã€è®¾å¤‡é” |
| **ä¸ªäººä¸­å¿ƒ** | èµ„æ–™ä¿®æ”¹ã€å®‰å…¨ä¸­å¿ƒã€å¯†ç ä¿®æ”¹ |
| **ç´ æåŠŸèƒ½** | æµè§ˆã€è¯¦æƒ…ã€äºŒåˆ›ï¼ˆAI ä¼˜åŒ–ï¼‰ã€æˆ‘çš„ç´ æ |
| **ç®¡ç†åå°** | ç´ æç®¡ç†ã€æ‰¹é‡ä¸Šä¼ ã€ç”¨æˆ·ç®¡ç†ã€æƒé™ç®¡ç†ã€å¡å¯†ç®¡ç† |
| **å®‰å…¨é˜²æŠ¤** | SQL æ³¨å…¥é˜²æŠ¤ã€CSRF é˜²æŠ¤ã€XSS é˜²æŠ¤ã€API é™æµã€å¯†ç åŠ å¯† |
| **å¼‚æ­¥å¤„ç†** | Celery + Redis å¼‚æ­¥ä»»åŠ¡ã€DeepSeek API è°ƒç”¨ |
| **æ—¥å¿—ç³»ç»Ÿ** | æ“ä½œæ—¥å¿—ã€é”™è¯¯æ—¥å¿—ã€æ—¥å¿—æ»šåŠ¨ |

å¸Œæœ›è¿™ä»½æ–‡æ¡£èƒ½å¸®åŠ©ä½ å¿«é€Ÿç†è§£é¡¹ç›®ï¼ğŸ‰
