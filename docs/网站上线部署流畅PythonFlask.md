这份笔记已经为你进行了深度优化，涵盖了从底层逻辑到具体指令的所有细节。它不仅记录了“怎么做”，还记录了“为什么这么做”以及“报错了怎么办”。

你可以将此内容保存为 **`AI-XianYu-Sucai-Project-SOP.md`**。

---

# 🚀 AI 咸鱼素材库：从零部署与全生命周期运维手册

## 一、 核心环境档案

* **服务器 IP**：`122.152.232.182`
* **操作系统**：OpenCloudOS 9 (CentOS 兼容版)
* **管理面板**：宝塔面板 (端口 8888)
* **项目路径**：`/www/wwwroot/AI-XianYu-Sucai-app`
* **技术栈细节**：
* **Python**: 3.11.4
* **Web 服务器**: Gunicorn (工作进程管理)
* **反向代理**: Nginx (处理 80 端口转发)
* **数据库**: SQLite 3 (文件名为 `app.db`)



---

## 二、 第一阶段：GitHub 代码仓库深度清理

在部署前，必须确保仓库中不含垃圾文件，否则会导致服务器依赖冲突。

### 1. 修正 `.gitignore`

确保本地项目根目录下的 `.gitignore` 包含以下内容：

```text
venv/
__pycache__/
*.pyc
instance/
.env
node_modules/
app.db

```

### 2. 强制同步仓库（解决忽略文件不起作用的问题）

在本地终端执行，将已上传的垃圾文件从 GitHub 索引中剔除：

```bash
git rm -r --cached .      # 清空 Git 对当前目录所有文件的追踪索引
git add .                 # 重新按 .gitignore 规则读取文件
git commit -m "chore: 彻底清理 node_modules 和缓存"
git push origin main

```

---

## 三、 第二阶段：服务器“纯净级”部署流程

### 1. 彻底清空旧环境

进入宝塔【文件】，在 `/www/wwwroot/AI-XianYu-Sucai-app` 目录下打开终端：

```bash
rm -rf .* * # 强制删除包括隐藏文件在内的所有内容，确保 clone 目录为空

```

### 2. 拉取代码

```bash
git clone https://github.com/yujiaqi3163/AI-XianYu-Sucai-app.git .

```

### 3. Python 项目管理器设置

* **添加项目**：
* **路径**：`/www/wwwroot/AI-XianYu-Sucai-app`
* **启动方式**：`gunicorn`（**严禁**直接用 python 启动，gunicorn 更稳定）
* **启动文件**：`run.py` | **端口**：`5000`
* **勾选**：安装模块依赖


* **补全缺失模块**：
点击【模块】，手动安装 `email-validator`。注册功能报错 `Internal Server Error` 通常是因为漏掉这个包。

### 4. 权限与所有者（最易出错点）

由于 Gunicorn 以 `www` 用户运行，必须保证它对数据库有写权限：

* **操作**：在宝塔【文件】中对项目文件夹右键 -> 【权限】。
* **设置**：所有者选择 **`www`**，权限 **755**，务必勾选 **“应用到子目录”**。

---

## 四、 第三阶段：后续更新与同步 SOP

当你在本地修改了代码（例如修改了 HTML 或增加了新路由），请执行此标准流程：

### 步骤 1：本地推送

```bash
git add .
git commit -m "update: 描述你的修改内容"
git push origin main

```

### 步骤 2：服务器同步

1. 登录宝塔，进入项目目录终端。
2. 执行 `git pull`。
3. **核心动作**：回到【Python 项目管理器】，点击 **【重启】**。

### 步骤 3：数据库变更处理（高能预警）

* **如果是 UI/逻辑修改**：只需重启。
* **如果是修改了数据库表结构**：
1. **备份**：先把服务器上的 `app.db` 下载到本地。
2. **更新**：在本地完成数据库迁移（Migration）后，将新的 `app.db` 上传覆盖（注意：这会覆盖掉服务器上的新注册用户数据，建议在正式运营后改用 `Flask-Migrate` 进行增量更新）。



---

## 五、 故障应急排查清单

| 现象 | 可能原因 | 解决方案 |
| --- | --- | --- |
| **网页显示 502 Bad Gateway** | Gunicorn 进程挂了 | 在管理器中点击重启；检查日志看是否有代码语法错误。 |
| **注册/提交显示 500 Error** | 权限不足 / 缺少模块 | 1. 确认 `app.db` 所有者是 `www`；2. 检查日志是否有 `ModuleNotFoundError`。 |
| **修改了代码但网页没变** | 缓存 / 未重启 | 1. 必须在管理器点“重启”；2. 浏览器开启无痕模式访问。 |
| **数据库尝试写入只读文件** | 文件夹权限被重置 | 再次执行“应用到子目录”的所有者权限修改（www/755）。 |

---

## 六、 进阶安全建议

1. **安全组**：腾讯云后台只需开放 `80`, `443`, `8888`, `22`。`5000` 端口在开启 Nginx 映射后可以关闭，增加安全性。
2. **备份任务**：在宝塔【计划任务】添加一个“备份目录”，每天凌晨 3 点执行，备份 `/www/wwwroot/AI-XianYu-Sucai-app`。

---

**这份 SOP 是你网站的“说明书”，建议打印或永久保存在你的云笔记中。**