# 项目部署指南

## 文档版本: v1.1
最后更新: 2026-02-22

---

## 目录

1. [文件分类说明](#一文件分类说明)
2. [Git 提交最佳实践](#二git-提交最佳实践)
3. [服务器部署步骤](#三服务器部署步骤)
4. [数据库初始化](#四数据库初始化)
5. [超级管理员初始化](#五超级管理员初始化)
6. [常见问题](#六常见问题)

---

## 一、文件分类说明

### ✅ 可提交到 Git 的文件（源代码和配置）

| 目录/文件 | 说明 |
|------------|------|
| `app/` | 应用核心代码 |
| `scripts/init_database.py` | 数据库初始化脚本 |
| `scripts/migrate_*.py` | 数据库迁移脚本（可选保留） |
| `templates/` | HTML 模板文件 |
| `static/css/` | 静态资源（CSS、JS） |
| `static/src/` | Tailwind 源文件 |
| `requirements.txt` | Python 依赖列表 |
| `run.py` | 应用启动文件 |
| `.env.example` | 环境变量示例文件 |
| `.gitignore` | Git 忽略配置 |
| `package.json` | Node 依赖配置 |
| `tailwind.config.js` | Tailwind 配置 |
| `*.md` | 项目文档 |

---

### ❌ 不可提交到 Git 的文件（敏感/临时/缓存）

| 目录/文件 | 说明 | 原因 |
|------------|------|------|
| `venv/` | 虚拟环境 | 本地依赖，服务器重新安装 |
| `node_modules/` | Node 模块 | 本地依赖，服务器重新安装 |
| `.env` | 环境变量 | 包含密钥、密码等敏感信息 |
| `app.db` | SQLite 数据库 | 用户数据，不应该提交 |
| `*.db` | 数据库文件 | 用户数据 |
| `logs/` | 日志目录 | 运行日志，临时文件 |
| `*.log` | 日志文件 | 运行日志，临时文件 |
| `app/static/uploads/` | 上传文件 | 用户上传内容 |
| `static/uploads/` | 上传文件 | 用户上传内容 |
| `.vscode/` | VS Code 配置 | 个人 IDE 配置 |
| `.idea/` | PyCharm 配置 | 个人 IDE 配置 |
| `__pycache__/` | Python 缓存 | 自动生成 |
| `*.pyc` | Python 编译文件 | 自动生成 |
| `.DS_Store` | macOS 系统文件 | 系统自动生成 |
| `Thumbs.db` | Windows 缩略图 | 系统自动生成 |

---

## 二、Git 提交最佳实践

### 提交前检查清单

- [ ] 确保 `.env` 文件不在暂存区
- [ ] 确保 `app.db` 不在暂存区
- [ ] 确保 `logs/` 目录不在暂存区
- [ ] 确保上传文件目录不在暂存区
- [ ] 检查代码中没有硬编码的密钥
- [ ] 更新 `requirements.txt`（如有新增依赖）

---

## 三、服务器部署步骤

### 3.1 环境要求

- Python 3.8+
- pip
- Git（可选，用于拉取代码）

### 3.2 部署步骤

#### 步骤 1: 拉取代码

```bash
# 如果使用 Git
git clone <repository_url>
cd my_flask_app

# 或者直接上传文件
```

#### 步骤 2: 创建虚拟环境

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Linux/Mac
python3 -m venv venv
source venv/bin/activate
```

#### 步骤 3: 安装依赖

```bash
pip install -r requirements.txt
```

#### 步骤 4: 配置环境变量

```bash
# 复制环境变量示例文件
cp .env.example .env

# 编辑 .env 文件，填入实际配置
# 设置 SECRET_KEY、邮箱配置、API Key 等
```

**重要**: 服务器上必须设置以下环境变量：

```env
# .env 文件内容示例
SECRET_KEY=your-secret-key-here-change-this-in-production
MAIL_SERVER=smtp.163.com
MAIL_PORT=465
MAIL_USE_SSL=True
MAIL_USERNAME=your-email@163.com
MAIL_PASSWORD=your-email-password
DEEPSEEK_API_KEY=your-deepseek-api-key
```

#### 步骤 5: 初始化数据库

```bash
# 仅初始化数据库
python scripts/init_database.py

# 或者初始化并创建示例数据
python scripts/init_database.py --sample
```

#### 步骤 6: 运行应用（开发环境）

```bash
python run.py
```

#### 步骤 7: 生产环境部署（使用 Gunicorn）

```bash
# 安装 Gunicorn
pip install gunicorn

# 启动应用
gunicorn -w 4 -b 0.0.0.0:5000 run:app
```

---

## 四、数据库初始化

### 4.1 使用整合后的初始化脚本

```bash
# 方式 1: 仅初始化数据库结构
python scripts/init_database.py

# 方式 2: 交互式初始化
python scripts/init_database.py
# 然后按提示输入 y

# 方式 3: 初始化并创建示例数据
python scripts/init_database.py --sample
```

### 4.2 初始化脚本功能

1. **创建所有数据库表
2. **迁移用户表（添加 avatar、bio、gender、birthday）
3. **迁移设备锁字段**
4. **迁移解绑申请字段**
5. **迁移卡密表**
6. **迁移用户素材表**
7. **初始化配置表**

### 4.3 示例数据（使用 --sample 参数）

创建以下示例数据：

- **3 个素材分类**: 朋友圈、小红书、抖音
- **4 个测试卡密**:
  - `sk-test-permanent-001`（永久）
  - `sk-test-1year-001`（1 年）
  - `sk-test-1month-001`（1 个月）
  - `sk-test-1day-001`（1 天）

---

## 五、超级管理员初始化

### 5.1 特性说明

超级管理员账号具有以下特性：

- ✅ **跳过设备锁验证**: 可以在任意设备上登录，无需绑定设备
- ✅ **完整管理员权限**: 可访问管理后台所有功能
- ✅ **设置邮箱**: 绑定到 2798479668@qq.com

### 5.2 初始化超级管理员

运行以下命令创建或更新超级管理员：

```bash
python scripts/create_super_admin.py
```

### 5.3 登录信息

| 项 | 值 |
|-----|-----|
| 用户名 | `admin` |
| 邮箱 | `2798479668@qq.com` |
| 密码 | `Aa123456!` |

---

## 六、常见问题

### Q: 数据库迁移失败怎么办？

**A**: 如果数据库已存在部分表，初始化脚本会跳过已存在的列，不会报错。

### Q: 如何重置数据库？

**A**: 删除 `app.db` 文件，重新运行初始化脚本。

```bash
# 删除数据库文件
rm app.db

# 重新初始化
python scripts/init_database.py --sample
```

### Q: 服务器上如何更新代码？

**A**:

```bash
# 拉取最新代码
git pull

# 激活虚拟环境
source venv/bin/activate

# 安装新依赖（如有）
pip install -r requirements.txt

# 运行数据库迁移（如有）
python scripts/init_database.py

# 重启应用
```

### Q: 上传文件目录权限问题？

**A**: 确保上传目录有写入权限：

```bash
# Linux/Mac
chmod 755 app/static/uploads
chown -R www-data:www-data app/static/uploads
```

### Q: 日志文件过大？

**A**: 日志系统已配置轮转，会自动清理旧日志。
