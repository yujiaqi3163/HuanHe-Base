{% extends "base.html" %}

{% block header %}
{% endblock %}

{% block content %}
<div class="px-4 py-6 space-y-6">
    
    <!-- è¿”å›æŒ‰é’® -->
    <div class="flex items-center gap-3">
        <a href="{{ url_for('main.security_center') }}" class="w-10 h-10 rounded-full bg-white shadow-sm border border-gray-100 flex items-center justify-center active:bg-gray-50 transition-colors">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 class="text-xl font-bold text-gray-800">è®¾å¤‡ç»‘å®š</h1>
    </div>

    <!-- è®¾å¤‡ç»‘å®šçŠ¶æ€ -->
    <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 space-y-4">
        
        <!-- è®¾å¤‡ç»‘å®šçŠ¶æ€ -->
        <div class="bg-gray-50 rounded-2xl p-4">
            <p class="text-[11px] text-gray-400 mb-1">è®¾å¤‡ç»‘å®šçŠ¶æ€</p>
            {% if current_user.bound_device_id %}
                <p class="text-sm text-gray-800 mb-2">âœ… å·²ç»‘å®šè®¾å¤‡</p>
                <p class="text-[11px] text-gray-400 font-mono break-all">{{ current_user.bound_device_id }}</p>
            {% else %}
                <p class="text-sm text-gray-500">âŒ æœªç»‘å®šè®¾å¤‡</p>
            {% endif %}
        </div>
        
        <!-- è§£ç»‘ç”³è¯·çŠ¶æ€ -->
        {% if current_user.device_unbind_status == 1 %}
        <div class="bg-yellow-50 rounded-2xl p-4 border border-yellow-100">
            <p class="text-sm font-bold text-yellow-700 mb-1">ğŸ“‹ è§£ç»‘ç”³è¯·ä¸­</p>
            <p class="text-[11px] text-yellow-600">è¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹</p>
            {% if current_user.device_unbind_requested_at %}
            <p class="text-[10px] text-yellow-500 mt-1">ç”³è¯·æ—¶é—´: {{ current_user.device_unbind_requested_at.strftime('%Y-%m-%d %H:%M') }}</p>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- ç”³è¯·è§£ç»‘æŒ‰é’® -->
        {% if current_user.bound_device_id and current_user.device_unbind_status != 1 %}
        <div class="space-y-3">
            <div class="text-[11px] text-gray-400">
                éœ€è¦æ›´æ¢è®¾å¤‡ï¼Ÿè¯·ç”³è¯·è§£ç»‘ï¼Œç®¡ç†å‘˜å®¡æ‰¹åå³å¯åœ¨æ–°è®¾å¤‡ç™»å½•ã€‚
            </div>
            <button type="button" id="request-unbind-btn" class="w-full py-4 bg-orange-600 text-white font-bold rounded-2xl shadow-lg shadow-orange-100 active:scale-95 transition-transform" onclick="requestUnbind()">
                ç”³è¯·è§£ç»‘è®¾å¤‡
            </button>
        </div>
        {% elif not current_user.bound_device_id %}
        <div class="text-center py-4 text-gray-400">
            <p class="text-sm">å½“å‰æ— è®¾å¤‡ç»‘å®šï¼Œæ— éœ€ç”³è¯·</p>
        </div>
        {% endif %}
    </div>

</div>

<script>
    function requestUnbind() {
        if (!confirm('ç¡®å®šè¦ç”³è¯·è§£ç»‘è®¾å¤‡å—ï¼Ÿ\nç”³è¯·åéœ€ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹ï¼Œå®¡æ‰¹é€šè¿‡åå¯åœ¨æ–°è®¾å¤‡ç™»å½•ã€‚')) {
            return;
        }
        
        const btn = document.getElementById('request-unbind-btn');
        btn.disabled = true;
        btn.textContent = 'ç”³è¯·ä¸­...';
        
        fetch('/auth/api/request-unbind', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                username_or_email: '{{ current_user.username }}' 
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            return response.json().then(err => Promise.reject(err));
        })
        .then(data => {
            if (data.success) {
                alert('è§£ç»‘ç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹');
                window.location.reload();
            } else {
                alert(data.message || 'ç”³è¯·å¤±è´¥');
                btn.disabled = false;
                btn.textContent = 'ç”³è¯·è§£ç»‘è®¾å¤‡';
            }
        })
        .catch(error => {
            alert(error.message || 'ç”³è¯·å¤±è´¥ï¼Œè¯·é‡è¯•');
            btn.disabled = false;
            btn.textContent = 'ç”³è¯·è§£ç»‘è®¾å¤‡';
        });
    }
</script>
{% endblock %}

{% block footer %}
{% endblock %}

