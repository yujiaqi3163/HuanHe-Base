{% extends "base.html" %}

{% block header %}
<!-- æ²‰æµ¸å¼é¡¶éƒ¨å¯¼èˆª -->
<header class="fixed top-0 inset-x-0 z-50 flex items-center justify-between px-4 py-2 bg-white/60 backdrop-blur-xl border-b border-gray-100/50">
    <a href="{{ url_for('main.my_materials') }}" class="w-8 h-8 flex items-center justify-center bg-white rounded-xl shadow-sm border border-gray-100 active:scale-90 transition-transform">
        <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1 class="text-lg font-black text-gray-900">æˆ‘çš„ç´ æ</h1>
    <div class="w-8"></div>
</header>
{% endblock %}

{% block content %}
<style>
    /* å¼ºåˆ¶è¦†ç›–æ‰€æœ‰å®½åº¦é™åˆ¶ */
    main {
        max-width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    /* éšè—åº•éƒ¨å¯¼èˆªæ  */
    nav.fixed.bottom-6 {
        display: none !important;
    }
    /* ç§»é™¤bodyçš„åº•éƒ¨padding */
    body {
        padding-bottom: 0 !important;
    }
</style>
<!-- é¡¶éƒ¨paddingå¢åŠ ï¼Œé¿å…è¢«å¯¼èˆªé®æŒ¡ -->
<div class="pt-16 pb-4 space-y-6 overflow-x-hidden">

    <!-- 1. ç´ æå¤§å›¾è½®æ’­ (1:1 æ¯”ä¾‹) -->
    <div class="space-y-3">
        <!-- è½®æ’­å›¾å®¹å™¨ -->
        <div id="carousel-wrapper" class="relative overflow-hidden touch-pan-y w-full">
            <div id="carousel-track" class="flex cursor-grab active:cursor-grabbing" style="will-change: transform;">
                {% for img in user_material.images %}
                <div class="carousel-slide shrink-0 w-full px-4" data-index="{{ loop.index0 }}">
                    <div class="relative rounded-[40px] overflow-hidden aspect-square shadow-2xl shadow-blue-100/50 border-4 border-white">
                        <div class="relative w-full h-full" data-css-recipe="{{ img.css_recipe|default('') }}">
                            <img src="{{ img.image_url }}" 
                                 alt="ç´ æé¢„è§ˆ {{ loop.index }}" 
                                 class="absolute inset-0 w-full h-full object-cover">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- è½®æ’­å›¾æŒ‡ç¤ºå™¨ -->
        {% if user_material.images|length > 1 %}
        <div class="flex justify-center gap-1.5 mt-2" id="carousel-dots">
            {% for img in user_material.images %}
            <div class="{% if loop.first %}w-4 h-1.5 bg-blue-600{% else %}w-1.5 h-1.5 bg-gray-200{% endif %} rounded-full transition-all duration-300"></div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- 2. æ ‡é¢˜ã€æ–‡æ¡ˆå¡ç‰‡ -->
    <div class="px-4 space-y-4">
        <div class="bg-white rounded-[32px] p-6 border border-gray-100 shadow-sm space-y-5">
            <!-- æ ‡é¢˜ -->
            <div class="flex items-center gap-4">
                <h2 class="text-sm font-bold text-gray-500 shrink-0">æ ‡é¢˜ï¼š</h2>
                <h1 class="text-lg font-black text-blue-600 truncate flex-1">
                    {{ user_material.title }}
                </h1>
            </div>
            
            <!-- æ–‡æ¡ˆ -->
            {% if user_material.description %}
            <div class="space-y-3">
                <div class="flex items-center gap-4">
                    <h2 class="text-sm font-bold text-gray-500 shrink-0">æ–‡æ¡ˆï¼š</h2>
                </div>
                <div class="space-y-3">
                    <p id="copy-text" class="text-gray-700 text-sm leading-relaxed bg-gray-50 p-4 rounded-2xl">
                        {{ user_material.description }}
                    </p>
                    <div class="flex justify-end">
                        <button id="copy-btn" onclick="copyText()" class="px-4 py-2 bg-blue-600 text-white text-xs font-bold rounded-full shadow-sm active:scale-90 transition-all flex items-center gap-1.5">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            å¤åˆ¶æ–‡æ¡ˆ
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- ä¸‹è½½ç»Ÿè®¡ -->
            <div class="flex items-center gap-4">
                <h2 class="text-sm font-bold text-gray-500 shrink-0">ä¸‹è½½æ¬¡æ•°ï¼š</h2>
                <span class="text-sm text-blue-600 font-bold">
                    {{ user_material.download_count }} æ¬¡
                </span>
            </div>
            
            <!-- åˆ›å»ºæ—¶é—´ -->
            <div class="flex items-center gap-4">
                <h2 class="text-sm font-bold text-gray-500 shrink-0">åˆ›å»ºäºï¼š</h2>
                <span class="text-sm text-gray-600">
                    {{ user_material.created_at.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}
                </span>
            </div>
        </div>
    </div>

    <!-- 3. ä¸‹è½½æ“ä½œé¢æ¿ -->
    <div class="px-4 space-y-4 pt-2">
        <div class="grid grid-cols-2 gap-3">
            <button onclick="downloadMaterial()" class="relative overflow-hidden group flex flex-col items-center justify-center gap-1 bg-gradient-to-br from-green-600 to-emerald-700 py-4 rounded-[28px] shadow-lg shadow-green-200 active:scale-95 transition-all">
                <!-- è£…é¥°å…‰æ™• -->
                <div class="absolute -top-10 -right-10 w-20 h-20 bg-white/20 blur-2xl rounded-full group-hover:scale-150 transition-transform"></div>
                
                <span class="text-sm font-black text-white flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    ä¸‹è½½ç´ æ
                </span>
                <span class="text-[9px] text-white/70 font-medium">ä¿å­˜åˆ°æœ¬åœ°</span>
            </button>
            
            <button onclick="deleteMaterial()" class="relative overflow-hidden group flex flex-col items-center justify-center gap-1 bg-gradient-to-br from-red-500 to-rose-600 py-4 rounded-[28px] shadow-lg shadow-red-200 active:scale-95 transition-all">
                <span class="text-sm font-black text-white flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    åˆ é™¤ä½œå“
                </span>
                <span class="text-[9px] text-white/70 font-medium">æ°¸ä¹…åˆ é™¤</span>
            </button>
        </div>
    </div>

</div>

<script>
    console.log('æˆ‘çš„ç´ æè¯¦æƒ…é¡µè„šæœ¬åŠ è½½æˆåŠŸ');
    
    // è·å–è®¾å¤‡IDï¼ˆä¸ç™»å½•é¡µé¢ä¿æŒä¸€è‡´ï¼‰
    function getDeviceId() {
        let deviceId = localStorage.getItem('device_id');
        if (!deviceId) {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 15);
            deviceId = timestamp + '_' + random;
            localStorage.setItem('device_id', deviceId);
            console.log('âœ… æ–°è®¾å¤‡IDç”Ÿæˆ:', deviceId);
        } else {
            console.log('âœ… ä½¿ç”¨ç°æœ‰è®¾å¤‡ID:', deviceId);
        }
        return deviceId;
    }
    
    // å®Œå…¨å¤åˆ¶ä¸»é¡µè½®æ’­å›¾é€»è¾‘
    document.addEventListener('DOMContentLoaded', () => {
        console.log('=== å¼€å§‹åˆå§‹åŒ–è½®æ’­å›¾ ===');
        
        // è½®æ’­å›¾é€»è¾‘
        const wrapper = document.getElementById('carousel-wrapper');
        const track = document.getElementById('carousel-track');
        const dotsContainer = document.getElementById('carousel-dots');
        const dots = dotsContainer ? dotsContainer.children : [];
        const originalSlides = Array.from(track.children);
        const slideCount = originalSlides.length;
        
        console.log('wrapper:', wrapper);
        console.log('track:', track);
        console.log('slideCount:', slideCount);
        console.log('wrapper.offsetWidth:', wrapper.offsetWidth);
        
        if (slideCount <= 1) {
            console.log('åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œä¸éœ€è¦è½®æ’­');
            return;
        }
        
        const firstClone = originalSlides[0].cloneNode(true);
        const lastClone = originalSlides[slideCount - 1].cloneNode(true);
        
        track.appendChild(firstClone); 
        track.insertBefore(lastClone, track.firstChild); 

        const getStepWidth = () => wrapper.offsetWidth;
        let step = getStepWidth();
        console.log('step:', step);
        
        let currentIndex = 1; 
        let startX = 0;
        let currentTranslate = -currentIndex * step;
        let prevTranslate = currentTranslate;
        let isDragging = false;
        let autoPlayTimer;

        function setTransform(x) {
            track.style.transform = `translateX(${x}px)`;
        }

        function updateDots() {
            if (!dotsContainer) return;
            let realIndex = currentIndex - 1;
            if (realIndex < 0) realIndex = slideCount - 1;
            if (realIndex >= slideCount) realIndex = 0;

            Array.from(dots).forEach((dot, i) => {
                dot.className = i === realIndex 
                    ? "w-4 h-1.5 bg-blue-600 rounded-full transition-all duration-300"
                    : "w-1.5 h-1.5 bg-gray-200 rounded-full transition-all duration-300";
            });
        }

        track.addEventListener('touchstart', (e) => {
            stopAuto();
            startX = e.touches[0].clientX;
            isDragging = true;
            track.style.transition = 'none';
        });

        track.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const diff = e.touches[0].clientX - startX;
            currentTranslate = prevTranslate + diff;
            setTransform(currentTranslate);
        });

        track.addEventListener('touchend', (e) => {
            isDragging = false;
            const movedBy = currentTranslate - prevTranslate;

            if (movedBy < -step / 10) currentIndex++;
            else if (movedBy > step / 10) currentIndex--;

            scrollToIndex();
            startAuto();
        });

        function scrollToIndex(animated = true) {
            track.style.transition = animated ? 'transform 0.4s cubic-bezier(0.25, 1, 0.35, 1)' : 'none';
            currentTranslate = -currentIndex * step;
            setTransform(currentTranslate);
            prevTranslate = currentTranslate;
            updateDots();

            if (animated) {
                setTimeout(() => {
                    if (currentIndex === 0) {
                        currentIndex = slideCount;
                        scrollToIndex(false);
                    }
                    if (currentIndex === slideCount + 1) {
                        currentIndex = 1;
                        scrollToIndex(false);
                    }
                }, 400);
            }
        }

        function startAuto() {
            stopAuto();
            autoPlayTimer = setInterval(() => {
                currentIndex++;
                scrollToIndex();
            }, 4000);
        }

        function stopAuto() {
            clearInterval(autoPlayTimer);
        }

        // åº”ç”¨CSSæ··åˆ
        applyCssMixing();
        
        setTransform(currentTranslate);
        updateDots();
        startAuto();
        console.log('è½®æ’­å›¾åˆå§‹åŒ–å®Œæˆ');
        
        window.addEventListener('resize', () => {
            step = getStepWidth();
            currentTranslate = -currentIndex * step;
            prevTranslate = currentTranslate;
            setTransform(currentTranslate);
        });
    });
    
    // åº”ç”¨CSSæ··åˆæ•ˆæœ
    function applyCssMixing() {
        const containers = document.querySelectorAll('[data-css-recipe]');
        
        containers.forEach(container => {
            const recipeJson = container.getAttribute('data-css-recipe');
            
            if (!recipeJson || recipeJson.trim() === '') {
                return;
            }
            
            try {
                const recipe = JSON.parse(recipeJson);
                const img = container.querySelector('img');
                
                if (img && recipe) {
                    // åº”ç”¨æ»¤é•œ
                    img.style.filter = `contrast(${recipe.contrast}) brightness(${recipe.brightness}) saturate(${recipe.saturation})`;
                    
                    // åˆ›å»ºå åŠ å±‚
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        mix-blend-mode: ${recipe.blend_mode};
                        background: ${recipe.gradient};
                        opacity: ${recipe.opacity};
                        pointer-events: none;
                    `;
                    
                    container.appendChild(overlay);
                    console.log('âœ… CSSæ··åˆåº”ç”¨æˆåŠŸ:', recipe);
                }
            } catch (e) {
                console.error('è§£æCSSé…æ–¹å¤±è´¥:', e, recipeJson);
            }
        });
    }

    // å¤åˆ¶æ–‡æ¡ˆ
    async function copyText() {
        const text = document.getElementById('copy-text').innerText;
        const btn = document.getElementById('copy-btn');
        
        try {
            let success = false;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(text);
                    success = true;
                } catch (err) {
                    console.log('navigator.clipboard å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ');
                }
            }
            
            if (!success) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                textarea.style.top = '-9999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                
                try {
                    const result = document.execCommand('copy');
                    success = result;
                } catch (err) {
                    console.log('execCommand å¤±è´¥');
                }
                
                document.body.removeChild(textarea);
            }
            
            if (success) {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    å·²å¤åˆ¶
                `;
                btn.classList.replace('bg-blue-600', 'bg-green-600');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.replace('bg-green-600', 'bg-blue-600');
                }, 2000);
            } else {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰æ‰‹åŠ¨å¤åˆ¶');
            }
        } catch (error) {
            console.error('å¤åˆ¶å¤±è´¥:', error);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        }
    }

    // ä¸‹è½½ç´ æ
    async function downloadMaterial() {
        const userMaterialId = {{ user_material.id }};
        
        // ä½¿ç”¨ tojson è¿‡æ»¤å™¨å®‰å…¨åœ°ä¼ é€’å›¾ç‰‡æ•°æ®
        const imageData = {{ user_material.images|map(attribute='image_url')|list|tojson }};
        const imageUrls = imageData;
        
        console.log('=== ä¸‹è½½è°ƒè¯•ä¿¡æ¯ ===');
        console.log('ç´ æID:', userMaterialId);
        console.log('å›¾ç‰‡æ•°é‡:', imageUrls.length);
        console.log('å›¾ç‰‡åˆ—è¡¨:', imageUrls);
        
        if (imageUrls.length === 0) {
            alert('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡');
            return;
        }
        
        // æ¸©é¦¨æç¤º
        alert(`æ­£åœ¨ä¸ºæ‚¨ä¸‹è½½ ${imageUrls.length} å¼ å›¾ç‰‡ï¼Œè¯·ç¨ç­‰ç‰‡åˆ»ï¼Œä¸è¦å…³é—­é¡µé¢å“¦~ ğŸŒ¸`);
        
        try {
            // å…ˆæ›´æ–°ä¸‹è½½è®¡æ•°
            const deviceId = getDeviceId();
            await fetch(`/api/user-material/${userMaterialId}/download`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Device-ID': deviceId
                }
            });
            
            // é€ä¸ªä¸‹è½½å›¾ç‰‡
            let downloadedCount = 0;
            for (let i = 0; i < imageUrls.length; i++) {
                const imgUrl = imageUrls[i];
                console.log(`æ­£åœ¨ä¸‹è½½ç¬¬ ${i + 1}/${imageUrls.length} å¼ :`, imgUrl);
                try {
                    await downloadImage(imgUrl, `material_${userMaterialId}_${i + 1}.png`);
                    downloadedCount++;
                } catch (downloadError) {
                    console.error(`ä¸‹è½½ç¬¬ ${i + 1} å¼ å¤±è´¥:`, downloadError);
                }
                // å»¶è¿Ÿå·²ç»åœ¨ downloadImage å‡½æ•°ä¸­å¤„ç†äº†ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–å»¶è¿Ÿ
            }
            
            console.log(`å®é™…ä¸‹è½½å®Œæˆ: ${downloadedCount}/${imageUrls.length}`);
            alert(`ğŸ‰ å¤ªæ£’äº†ï¼æˆåŠŸä¸‹è½½ ${downloadedCount} å¼ å›¾ç‰‡ï¼\n\nå¿«å»æŸ¥çœ‹æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹å§~ âœ¨`);
        } catch (error) {
            console.error('ä¸‹è½½å¤±è´¥:', error);
            alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
    
    async function downloadImage(imageUrl, filename) {
        try {
            // ç›´æ¥ä½¿ç”¨ a æ ‡ç­¾ä¸‹è½½ï¼Œä¿æŒç®€å•
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = filename;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`âœ… ä¸‹è½½è§¦å‘æˆåŠŸ: ${filename}`);
            
            // ç­‰å¾…è¶³å¤Ÿæ—¶é—´è®©æµè§ˆå™¨å¤„ç†ä¸‹è½½
            await new Promise(resolve => setTimeout(resolve, 500));
        } catch (error) {
            console.error(`âŒ ä¸‹è½½å›¾ç‰‡å¤±è´¥: ${filename}`, error);
            throw error;
        }
    }
    
    async function deleteMaterial() {
        const userMaterialId = {{ user_material.id }};
        
        // ç¡®è®¤åˆ é™¤
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä½œå“å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/user-material/${userMaterialId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('âœ… ä½œå“å·²æˆåŠŸåˆ é™¤ï¼');
                // è·³è½¬åˆ°ä½œå“åº“é¡µé¢
                window.location.href = '{{ url_for('main.my_materials') }}';
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('åˆ é™¤å¤±è´¥:', error);
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
</script>
{% endblock %}
