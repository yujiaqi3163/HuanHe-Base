{% extends "base.html" %}

{% block header %}
<!-- æ²‰æµ¸å¼é¡¶éƒ¨å¯¼èˆª -->
<header class="fixed top-0 inset-x-0 z-50 flex items-center justify-between px-4 py-2 bg-white/60 backdrop-blur-xl border-b border-gray-100/50">
    <a href="javascript:history.back()" class="back-button">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1 class="text-lg font-black text-gray-900">ç´ æè¯¦æƒ…</h1>
    <button onclick="toggleFavorite()" id="collect-btn" class="back-button">
        <svg class="w-6 h-6 {% if is_favorited %}text-red-500{% else %}text-gray-400{% endif %}" id="collect-icon" fill="{% if is_favorited %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
        </svg>
    </button>
</header>
{% endblock %}

{% block content %}
<style>
    /* å¼ºåˆ¶è¦†ç›–æ‰€æœ‰å®½åº¦é™åˆ¶ */
    main {
        max-width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    /* éšè—åº•éƒ¨å¯¼èˆªæ  */
    nav.fixed.bottom-6 {
        display: none !important;
    }
    /* ç§»é™¤bodyçš„åº•éƒ¨padding */
    body {
        padding-bottom: 0 !important;
    }
</style>
<!-- é¡¶éƒ¨paddingå¢åŠ ï¼Œé¿å…è¢«å¯¼èˆªé®æŒ¡ -->
<div class="pt-16 pb-4 space-y-6 overflow-x-hidden">

    <!-- 1. ç´ æå¤§å›¾è½®æ’­ (1:1 æ¯”ä¾‹) -->
    <div class="space-y-3">
        <!-- è½®æ’­å›¾å®¹å™¨ -->
        <div id="carousel-wrapper" class="relative overflow-hidden touch-pan-y w-full">
            <div id="carousel-track" class="flex cursor-grab active:cursor-grabbing" style="will-change: transform;">
                {% for img in material.images %}
                <div class="carousel-slide shrink-0 w-full px-4" data-index="{{ loop.index0 }}">
                    <div class="relative rounded-[40px] overflow-hidden aspect-square shadow-2xl shadow-blue-100/50 border-4 border-white">
                        <img src="{{ img.image_url }}" alt="ç´ æé¢„è§ˆ {{ loop.index }}" class="absolute inset-0 w-full h-full object-cover">
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- è½®æ’­å›¾æŒ‡ç¤ºå™¨ -->
        {% if material.images|length > 1 %}
        <div class="flex justify-center gap-1.5 mt-2" id="carousel-dots">
            {% for img in material.images %}
            <div class="{% if loop.first %}w-4 h-1.5 bg-blue-600{% else %}w-1.5 h-1.5 bg-gray-200{% endif %} rounded-full transition-all duration-300"></div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- 2. æ ‡é¢˜ã€æ–‡æ¡ˆã€åˆ†ç±»å¡ç‰‡ -->
    <div class="px-4 space-y-4">
        <div class="bg-white rounded-[32px] p-6 border border-gray-100 shadow-sm space-y-5">
            <!-- æ ‡é¢˜ -->
            <div class="flex items-center gap-4">
                <h2 class="text-sm font-bold text-gray-500 shrink-0">æ ‡é¢˜ï¼š</h2>
                <h1 class="text-lg font-black text-blue-600 truncate flex-1">
                    {{ material.title }}
                </h1>
            </div>
            
            <!-- æ–‡æ¡ˆ -->
            {% if material.description %}
            <div class="flex items-start gap-4">
                <h2 class="text-sm font-bold text-gray-500 shrink-0 mt-1">æ–‡æ¡ˆï¼š</h2>
                <p class="text-gray-700 text-sm leading-relaxed line-clamp-3 flex-1">
                    "{{ material.description }}"
                </p>
            </div>
            {% endif %}
            
            <!-- åˆ†ç±» -->
            <div class="flex items-center gap-4">
                <h2 class="text-sm font-bold text-gray-500 shrink-0">åˆ†ç±»ï¼š</h2>
                <span class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-full text-sm font-black">
                    {{ material.material_type.name if material.material_type else 'æœªåˆ†ç±»' }}
                </span>
            </div>
        </div>
    </div>

    <!-- 5. ä¸‹è½½æ“ä½œé¢æ¿ -->
    <div class="px-4 space-y-4 pt-2">
        <!-- é«˜çº§AIä¸‹è½½ -->
        <button id="remix-btn" onclick="remixMaterial()" class="relative overflow-hidden group flex flex-col items-center justify-center gap-1 bg-gradient-to-br from-blue-600 to-indigo-700 py-4 rounded-[28px] shadow-lg shadow-blue-200 active:scale-95 transition-all w-full">
            <!-- è£…é¥°å…‰æ™• -->
            <div class="absolute -top-10 -right-10 w-20 h-20 bg-white/20 blur-2xl rounded-full group-hover:scale-150 transition-transform"></div>
            
            <span class="text-sm font-black text-white flex items-center gap-1.5">
                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2L14.4 9.6H22L15.8 14.2L18.2 21.8L12 17.2L5.8 21.8L8.2 14.2L2 9.6H9.6L12 2Z" />
                </svg>
                é«˜çº§ AI ä¸‹è½½
            </span>
            <span class="text-[9px] text-white/70 font-medium">å›¾ç”Ÿå›¾æ·±åº¦äºŒåˆ›</span>
        </button>
        <p id="status-text" class="text-center text-[10px] text-gray-400 font-medium">ç”Ÿæˆç»“æœå°†è‡ªåŠ¨ä¿å­˜è‡³ä½œå“åº“</p>
    </div>

</div>

<!-- æ·»åŠ  html2canvas åº“ -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
    console.log('ç´ æè¯¦æƒ…é¡µè„šæœ¬åŠ è½½æˆåŠŸ');
    
    // è·å–è®¾å¤‡IDï¼ˆä¸ç™»å½•é¡µé¢ä¿æŒä¸€è‡´ï¼‰
    function getDeviceId() {
        let deviceId = localStorage.getItem('device_id');
        if (!deviceId) {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 15);
            deviceId = timestamp + '_' + random;
            localStorage.setItem('device_id', deviceId);
            console.log('âœ… æ–°è®¾å¤‡IDç”Ÿæˆ:', deviceId);
        } else {
            console.log('âœ… ä½¿ç”¨ç°æœ‰è®¾å¤‡ID:', deviceId);
        }
        return deviceId;
    }
    
    // ç´ æäºŒåˆ›å¤„ç†
    let currentTaskId = null;
    let currentUserMaterialId = null;
    let isRemixing = false;
    let pollInterval = null;
    
    // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨åœ°è®¾ç½®çŠ¶æ€æ–‡å­—å’Œé¢œè‰²
    function setStatusText(text, color) {
        const statusText = document.getElementById('status-text');
        statusText.textContent = text;
        
        // å…ˆç§»é™¤æ‰€æœ‰é¢œè‰²ç±»ï¼Œå†æ·»åŠ æ–°çš„
        statusText.classList.remove('text-gray-400', 'text-blue-500', 'text-orange-500', 'text-red-500', 'text-green-500', 'text-yellow-500');
        
        // æ·»åŠ å¯¹åº”é¢œè‰²
        switch(color) {
            case 'gray':
                statusText.classList.add('text-gray-400');
                break;
            case 'blue':
                statusText.classList.add('text-blue-500');
                break;
            case 'orange':
                statusText.classList.add('text-orange-500');
                break;
            case 'red':
                statusText.classList.add('text-red-500');
                break;
            case 'green':
                statusText.classList.add('text-green-500');
                break;
            case 'yellow':
                statusText.classList.add('text-yellow-500');
                break;
        }
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šé‡ç½®æŒ‰é’®å’ŒçŠ¶æ€
    function resetButton() {
        const btn = document.getElementById('remix-btn');
        isRemixing = false;
        btn.disabled = false;
        btn.classList.remove('opacity-70', 'cursor-not-allowed');
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šç¦ç”¨æŒ‰é’®
    function disableButton() {
        const btn = document.getElementById('remix-btn');
        btn.disabled = true;
        btn.classList.add('opacity-70', 'cursor-not-allowed');
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šæ¸…ç†è½®è¯¢
    function clearPolling() {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }
    
    async function remixMaterial() {
        if (isRemixing) return;
        
        // æ£€æŸ¥å¡å¯†æœ‰æ•ˆæ€§
        const isMembershipValid = {{ is_membership_valid | tojson }};
        if (!isMembershipValid) {
            showSecretModal();
            return;
        }
        
        isRemixing = true;
        disableButton();
        setStatusText('æ­£åœ¨æäº¤äºŒåˆ›ä»»åŠ¡...', 'blue');
        
        const materialId = {{ material.id }};
        
        try {
            // æ¸…ç†æ—§çš„è½®è¯¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            clearPolling();
            
            // 1. è°ƒç”¨åç«¯APIæäº¤å¼‚æ­¥ä»»åŠ¡
            const deviceId = getDeviceId();
            const response = await fetch(`/api/material/${materialId}/remix`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Device-ID': deviceId
                }
            });
            
            if (!response.ok) {
                // å…ˆå…‹éš†å“åº”ï¼Œé¿å…åªèƒ½è¯»å–ä¸€æ¬¡çš„é—®é¢˜
                const clonedResponse = response.clone();
                
                try {
                    const errorData = await clonedResponse.json();
                    console.error('APIé”™è¯¯å“åº”:', errorData);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯429é™æµé”™è¯¯
                    if (response.status === 429 && errorData.msg) {
                        throw new Error(errorData.msg);
                    }
                    
                    throw new Error(errorData.message || errorData.msg || `æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
                } catch (jsonError) {
                    // å¦‚æœ JSON è§£æå¤±è´¥ï¼Œå°è¯•è¯»å–æ–‡æœ¬
                    try {
                        const errorText = await response.text();
                        console.error('APIé”™è¯¯å“åº”(æ–‡æœ¬):', errorText);
                        throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
                    } catch (textError) {
                        throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
                    }
                }
            }
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message || 'äºŒåˆ›å¤±è´¥');
            }
            
            currentTaskId = result.task_id;
            setStatusText(result.message, 'blue');
            
            // 2. å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
            startPolling(currentTaskId);
            
        } catch (error) {
            console.error('äºŒåˆ›å¤±è´¥:', error);
            
            const errorMsg = error.message || 'äºŒåˆ›å¤±è´¥';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯é™æµé”™è¯¯ï¼ˆåŒ…å«"ç­‰å¾…"å’Œ"ç§’"ï¼‰
            const waitMatch = errorMsg.match(/ç­‰å¾…(\d+)ç§’/);
            if (waitMatch) {
                const waitSeconds = parseInt(waitMatch[1]);
                setStatusText(errorMsg, 'orange');
                
                // ç¦ç”¨æŒ‰é’®ï¼Œå€’è®¡æ—¶ç»“æŸåæ¢å¤
                let countdown = waitSeconds;
                
                const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        setStatusText('ç”Ÿæˆç»“æœå°†è‡ªåŠ¨ä¿å­˜è‡³ä½œå“åº“', 'gray');
                        resetButton();
                    } else {
                        setStatusText(`è¯·ç­‰å¾…${countdown}ç§’åå†è¯•...`, 'orange');
                    }
                }, 1000);
            } else {
                setStatusText('äºŒåˆ›å¤±è´¥ï¼š' + errorMsg, 'red');
                resetButton();
            }
        }
    }
    
    function startPolling(taskId) {
        // æ¯éš”2ç§’æŸ¥è¯¢ä¸€æ¬¡ä»»åŠ¡çŠ¶æ€
        pollInterval = setInterval(async () => {
            try {
                const response = await fetch(`/api/task/${taskId}/status`);
                const result = await response.json();
                
                if (result.status === 'SUCCESS') {
                    // ä»»åŠ¡å®Œæˆ
                    clearPolling();
                    
                    if (result.result && result.result.success) {
                        currentUserMaterialId = result.result.user_material_id;
                        setStatusText('ğŸ‰ äºŒåˆ›å®Œæˆï¼å·²ä¿å­˜è‡³æˆ‘çš„ä½œå“åº“', 'green');
                        
                        // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼Œè®©ç”¨æˆ·å¯ä»¥å†æ¬¡æ“ä½œ
                        resetButton();
                        
                        // å»¶è¿Ÿå¼¹å‡ºç¡®è®¤æ¡†ï¼Œè®©ç”¨æˆ·å…ˆçœ‹åˆ°æˆåŠŸæç¤º
                        setTimeout(() => {
                            if (confirm('ç´ æäºŒåˆ›æˆåŠŸï¼æ˜¯å¦å‰å¾€ä½œå“åº“æŸ¥çœ‹ï¼Ÿ')) {
                                window.location.href = '/my-materials';
                            }
                            // æ— è®ºç”¨æˆ·ç‚¹å‡»ç¡®è®¤è¿˜æ˜¯å–æ¶ˆï¼ŒæˆåŠŸæç¤ºéƒ½ä¿ç•™
                        }, 500);
                    } else {
                        throw new Error(result.result?.error || 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥');
                    }
                    
                } else if (result.status === 'FAILURE') {
                    // ä»»åŠ¡å¤±è´¥
                    clearPolling();
                    
                    setStatusText('äºŒåˆ›å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'red');
                    resetButton();
                } else {
                    // ä»»åŠ¡è¿›è¡Œä¸­ï¼Œæ›´æ–°æç¤º
                    setStatusText(result.message, 'blue');
                }
                
            } catch (error) {
                console.error('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                clearPolling();
                
                setStatusText('æŸ¥è¯¢çŠ¶æ€å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°', 'yellow');
                resetButton();
            }
        }, 2000);
    }
    
    async function processImages(imagesData) {
        const processedImages = [];
        
        for (let i = 0; i < imagesData.length; i++) {
            const imgData = imagesData[i];
            const recipe = imgData.css_recipe;
            
            if (recipe) {
                console.log(`æ­£åœ¨å¤„ç†ç¬¬ ${i + 1}/${imagesData.length} å¼ å›¾ç‰‡...`);
                // ä½¿ç”¨CSSæ··åˆå¤„ç†å›¾ç‰‡
                const processedUrl = await processImageWithCSS(imgData.original_url, recipe);
                processedImages.push({ image_url: processedUrl });
                console.log(`âœ… ç¬¬ ${i + 1} å¼ å›¾ç‰‡å¤„ç†å®Œæˆ: ${processedUrl}`);
            } else {
                processedImages.push({ image_url: imgData.original_url });
            }
        }
        
        // æ›´æ–°åç«¯å›¾ç‰‡
        if (currentUserMaterialId && processedImages.length > 0) {
            console.log('æ­£åœ¨æ›´æ–°åç«¯å›¾ç‰‡è®°å½•...');
            await fetch(`/api/user-material/${currentUserMaterialId}/update-image`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ images: processedImages })
            });
            console.log('âœ… åç«¯å›¾ç‰‡è®°å½•æ›´æ–°å®Œæˆ');
        }
    }
    
    async function processImageWithCSS(imageUrl, recipe) {
        return new Promise((resolve) => {
            // åˆ›å»ºä¸´æ—¶å®¹å™¨
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed;
                left: -9999px;
                top: 0;
                z-index: -1;
            `;
            
            const renderDiv = document.createElement('div');
            renderDiv.id = `render-target-${Date.now()}`;
            renderDiv.style.cssText = `
                position: relative;
                width: 512px;
                line-height: 0;
            `;
            
            const img = document.createElement('img');
            img.crossOrigin = 'anonymous';
            img.src = imageUrl;
            img.style.cssText = `
                width: 100%;
                height: auto;
                filter: contrast(${recipe.contrast}) brightness(${recipe.brightness}) saturate(${recipe.saturation});
            `;
            
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                mix-blend-mode: ${recipe.blend_mode};
                background: ${recipe.gradient};
                opacity: ${recipe.opacity};
                pointer-events: none;
            `;
            
            renderDiv.appendChild(img);
            renderDiv.appendChild(overlay);
            container.appendChild(renderDiv);
            document.body.appendChild(container);
            
            img.onload = async () => {
                try {
                    // ä½¿ç”¨html2canvasæ¸²æŸ“
                    const canvas = await html2canvas(renderDiv, {
                        useCORS: true,
                        backgroundColor: null,
                        scale: 1
                    });
                    
                    // ä¿®æ”¹MD5
                    const ctx = canvas.getContext('2d');
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // åœ¨åƒç´ æ•°æ®æœ«å°¾æ·»åŠ éšæœºå­—èŠ‚ï¼ˆä¿®æ”¹MD5ï¼‰
                    const randomBytes = new Uint8Array([
                        Math.floor(Math.random() * 256),
                        Math.floor(Math.random() * 256),
                        Math.floor(Math.random() * 256)
                    ]);
                    
                    // åªä¿®æ”¹æœ€åå‡ ä¸ªåƒç´ ï¼Œä¸å½±å“è§†è§‰æ•ˆæœ
                    const data = imageData.data;
                    const len = data.length;
                    for (let i = 0; i < randomBytes.length && i * 4 < len; i++) {
                        data[len - (i + 1) * 4] = randomBytes[i];
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    
                    // è½¬æ¢ä¸ºbase64å¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨
                    const base64Data = canvas.toDataURL('image/png');
                    
                    // ä¸Šä¼ åˆ°æœåŠ¡å™¨
                    const deviceId = getDeviceId();
                    const uploadResponse = await fetch('/api/upload-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Device-ID': deviceId
                        },
                        body: JSON.stringify({ image: base64Data })
                    });
                    
                    const uploadResult = await uploadResponse.json();
                    
                    // æ¸…ç†
                    document.body.removeChild(container);
                    
                    if (uploadResult.success) {
                        resolve(uploadResult.data.image_url);
                    } else {
                        console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', uploadResult.message);
                        resolve(imageUrl);
                    }
                    
                } catch (error) {
                    console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error);
                    document.body.removeChild(container);
                    resolve(imageUrl); // å¤±è´¥åˆ™è¿”å›åŸå›¾
                }
            };
            
            img.onerror = () => {
                document.body.removeChild(container);
                resolve(imageUrl);
            };
        });
    }
    
    // å®Œå…¨å¤åˆ¶ä¸»é¡µè½®æ’­å›¾é€»è¾‘
    document.addEventListener('DOMContentLoaded', () => {
        console.log('=== å¼€å§‹åˆå§‹åŒ–è½®æ’­å›¾ ===');
        
        // è½®æ’­å›¾é€»è¾‘
        const wrapper = document.getElementById('carousel-wrapper');
        const track = document.getElementById('carousel-track');
        const dotsContainer = document.getElementById('carousel-dots');
        const dots = dotsContainer ? dotsContainer.children : [];
        const originalSlides = Array.from(track.children);
        const slideCount = originalSlides.length;
        
        console.log('wrapper:', wrapper);
        console.log('track:', track);
        console.log('slideCount:', slideCount);
        console.log('wrapper.offsetWidth:', wrapper.offsetWidth);
        
        if (slideCount <= 1) {
            console.log('åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œä¸éœ€è¦è½®æ’­');
            return;
        }
        
        const firstClone = originalSlides[0].cloneNode(true);
        const lastClone = originalSlides[slideCount - 1].cloneNode(true);
        
        track.appendChild(firstClone); 
        track.insertBefore(lastClone, track.firstChild); 

        const getStepWidth = () => wrapper.offsetWidth;
        let step = getStepWidth();
        console.log('step:', step);
        
        let currentIndex = 1; 
        let startX = 0;
        let currentTranslate = -currentIndex * step;
        let prevTranslate = currentTranslate;
        let isDragging = false;
        let autoPlayTimer;

        function setTransform(x) {
            track.style.transform = `translateX(${x}px)`;
        }

        function updateDots() {
            if (!dotsContainer) return;
            let realIndex = currentIndex - 1;
            if (realIndex < 0) realIndex = slideCount - 1;
            if (realIndex >= slideCount) realIndex = 0;

            Array.from(dots).forEach((dot, i) => {
                dot.className = i === realIndex 
                    ? "w-4 h-1.5 bg-blue-600 rounded-full transition-all duration-300"
                    : "w-1.5 h-1.5 bg-gray-200 rounded-full transition-all duration-300";
            });
        }

        track.addEventListener('touchstart', (e) => {
            stopAuto();
            startX = e.touches[0].clientX;
            isDragging = true;
            track.style.transition = 'none';
        });

        track.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const diff = e.touches[0].clientX - startX;
            currentTranslate = prevTranslate + diff;
            setTransform(currentTranslate);
        });

        track.addEventListener('touchend', (e) => {
            isDragging = false;
            const movedBy = currentTranslate - prevTranslate;

            if (movedBy < -step / 10) currentIndex++;
            else if (movedBy > step / 10) currentIndex--;

            scrollToIndex();
            startAuto();
        });

        function scrollToIndex(animated = true) {
            track.style.transition = animated ? 'transform 0.4s cubic-bezier(0.25, 1, 0.35, 1)' : 'none';
            currentTranslate = -currentIndex * step;
            setTransform(currentTranslate);
            prevTranslate = currentTranslate;
            updateDots();

            if (animated) {
                setTimeout(() => {
                    if (currentIndex === 0) {
                        currentIndex = slideCount;
                        scrollToIndex(false);
                    }
                    if (currentIndex === slideCount + 1) {
                        currentIndex = 1;
                        scrollToIndex(false);
                    }
                }, 400);
            }
        }

        function startAuto() {
            stopAuto();
            autoPlayTimer = setInterval(() => {
                currentIndex++;
                scrollToIndex();
            }, 4000);
        }

        function stopAuto() {
            clearInterval(autoPlayTimer);
        }

        setTransform(currentTranslate);
        updateDots();
        startAuto();
        console.log('è½®æ’­å›¾åˆå§‹åŒ–å®Œæˆ');
        
        window.addEventListener('resize', () => {
            step = getStepWidth();
            currentTranslate = -currentIndex * step;
            prevTranslate = currentTranslate;
            setTransform(currentTranslate);
        });
    });

    // æ”¶è—äº¤äº’
    async function toggleFavorite() {
        const materialId = {{ material.id }};
        const btn = document.getElementById('collect-btn');
        const icon = document.getElementById('collect-icon');
        
        try {
            const response = await fetch(`/api/material/${materialId}/favorite`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (result.is_favorited) {
                    icon.classList.remove('text-gray-400');
                    icon.classList.add('text-red-500');
                    icon.setAttribute('fill', 'currentColor');
                } else {
                    icon.classList.remove('text-red-500');
                    icon.classList.add('text-gray-400');
                    icon.setAttribute('fill', 'none');
                }
                
                setStatusText(result.message, 'green');
                setTimeout(() => setStatusText('ç”Ÿæˆç»“æœå°†è‡ªåŠ¨ä¿å­˜è‡³ä½œå“åº“', 'gray'), 2000);
            } else {
                setStatusText(result.message, 'red');
            }
        } catch (error) {
            console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
            setStatusText('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'red');
        }
    }
</script>

<!-- å¡å¯†å¤±æ•ˆæç¤ºæ¡† -->
<div id="secret-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="hideSecretModal()"></div>
    
    <!-- å¼¹å‡ºæ¡†å†…å®¹ -->
    <div class="relative bg-white rounded-[32px] p-6 w-full max-w-[340px] shadow-2xl animate-[fadeIn_0.3s_ease-out]">
        <!-- å…³é—­æŒ‰é’® -->
        <button onclick="hideSecretModal()" class="absolute top-4 right-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        
        <!-- å†…å®¹ -->
        <div class="text-center space-y-4 pt-2">
            <!-- å›¾ç‰‡ -->
            <div class="relative mx-auto w-24 h-24">
                <div class="absolute inset-0 bg-gradient-to-br from-orange-400 to-amber-500 rounded-full animate-pulse"></div>
                <div class="absolute inset-1 bg-white rounded-full flex items-center justify-center">
                    <svg class="w-12 h-12 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                    </svg>
                </div>
            </div>
            
            <!-- æ ‡é¢˜ -->
            <h3 class="text-xl font-black text-gray-800">å¡å¯†å·²å¤±æ•ˆ</h3>
            
            <!-- è¯´æ˜æ–‡å­— -->
            <div class="space-y-2 text-sm text-gray-600">
                <p>è¯·è”ç³»å®¢æœè·å–æ¿€æ´»å¡å¯†</p>
                <p class="text-xs text-gray-400">æ·»åŠ å®¢æœè¯·å¤‡æ³¨ï¼šå¡å¯†</p>
            </div>
            
            <!-- å®¢æœè”ç³»æ–¹å¼ -->
            <div class="bg-gradient-to-br from-orange-50 to-amber-50 rounded-2xl p-4 border border-orange-100">
                <div class="text-sm font-bold text-orange-600 mb-2">å®¢æœå¾®ä¿¡</div>
                <div class="bg-white rounded-xl p-3 text-center">
                    <span class="text-lg font-black text-gray-800">{{ customer_service_wechat }}</span>
                </div>
                <p class="text-xs text-gray-400 mt-2">é•¿æŒ‰å¤åˆ¶å¾®ä¿¡å·</p>
            </div>
            
            <!-- ç¡®å®šæŒ‰é’® -->
            <button onclick="hideSecretModal()" class="w-full py-3 bg-gradient-to-r from-orange-500 to-amber-500 text-white font-bold rounded-xl shadow-lg shadow-orange-200 active:scale-[0.98] transition-all">
                æˆ‘çŸ¥é“äº†
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
</style>

<script>
    function showSecretModal() {
        const modal = document.getElementById('secret-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }
    
    function hideSecretModal() {
        const modal = document.getElementById('secret-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
    }
</script>

{% endblock %}
