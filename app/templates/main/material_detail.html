{% extends "base.html" %}

{% block header %}
<!-- 沉浸式顶部导航 -->
<header class="fixed top-0 inset-x-0 z-50 flex items-center justify-between px-4 py-2 bg-white/60 backdrop-blur-xl border-b border-gray-100/50">
    <a href="javascript:history.back()" class="w-8 h-8 flex items-center justify-center bg-white rounded-xl shadow-sm border border-gray-100 active:scale-90 transition-transform">
        <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1 class="text-lg font-black text-gray-900">素材详情</h1>
    <button onclick="toggleAction('collect')" id="collect-btn" class="w-8 h-8 flex items-center justify-center bg-white rounded-xl shadow-sm border border-gray-100 active:scale-90 transition-all">
        <svg class="w-4 h-4 text-gray-400" id="collect-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
        </svg>
    </button>
</header>
{% endblock %}

{% block content %}
<style>
    /* 强制覆盖所有宽度限制 */
    main {
        max-width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    /* 隐藏底部导航栏 */
    nav.fixed.bottom-6 {
        display: none !important;
    }
    /* 移除body的底部padding */
    body {
        padding-bottom: 0 !important;
    }
</style>
<!-- 顶部padding增加，避免被导航遮挡 -->
<div class="pt-16 pb-4 space-y-6 overflow-x-hidden">

    <!-- 1. 素材大图轮播 (1:1 比例) -->
    <div class="space-y-3">
        <!-- 轮播图容器 -->
        <div id="carousel-wrapper" class="relative overflow-hidden touch-pan-y w-full">
            <div id="carousel-track" class="flex cursor-grab active:cursor-grabbing" style="will-change: transform;">
                {% for img in material.images %}
                <div class="carousel-slide shrink-0 w-full px-4" data-index="{{ loop.index0 }}">
                    <div class="relative rounded-[40px] overflow-hidden aspect-square shadow-2xl shadow-blue-100/50 border-4 border-white">
                        <img src="{{ img.image_url }}" alt="素材预览 {{ loop.index }}" class="absolute inset-0 w-full h-full object-cover">
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- 轮播图指示器 -->
        {% if material.images|length > 1 %}
        <div class="flex justify-center gap-1.5 mt-2" id="carousel-dots">
            {% for img in material.images %}
            <div class="{% if loop.first %}w-4 h-1.5 bg-blue-600{% else %}w-1.5 h-1.5 bg-gray-200{% endif %} rounded-full transition-all duration-300"></div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- 2. 标题、文案、分类卡片 -->
    <div class="px-4 space-y-4">
        <div class="bg-white rounded-[32px] p-6 border border-gray-100 shadow-sm space-y-5">
            <!-- 标题 -->
            <div class="flex items-center gap-4">
                <h2 class="text-sm font-bold text-gray-500 shrink-0">标题：</h2>
                <h1 class="text-lg font-black text-blue-600 truncate flex-1">
                    {{ material.title }}
                </h1>
            </div>
            
            <!-- 文案 -->
            {% if material.description %}
            <div class="flex items-start gap-4">
                <h2 class="text-sm font-bold text-gray-500 shrink-0 mt-1">文案：</h2>
                <p class="text-gray-700 text-sm leading-relaxed line-clamp-3 flex-1">
                    "{{ material.description }}"
                </p>
            </div>
            {% endif %}
            
            <!-- 分类 -->
            <div class="flex items-center gap-4">
                <h2 class="text-sm font-bold text-gray-500 shrink-0">分类：</h2>
                <span class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-full text-sm font-black">
                    {{ material.material_type.name if material.material_type else '未分类' }}
                </span>
            </div>
        </div>
    </div>

    <!-- 5. 下载操作面板 -->
    <div class="px-4 space-y-4 pt-2">
        <div class="grid grid-cols-2 gap-4">
            <!-- 普通下载 -->
            <button class="group flex flex-col items-center justify-center gap-1 bg-gray-50 border border-gray-200 py-4 rounded-[28px] active:bg-gray-100 transition-all">
                <span class="text-sm font-black text-gray-800">普通下载</span>
                <span class="text-[9px] text-gray-400 font-medium">CSS混合 + MD5去重</span>
            </button>

            <!-- 高级下载 -->
            <button class="relative overflow-hidden group flex flex-col items-center justify-center gap-1 bg-gradient-to-br from-blue-600 to-indigo-700 py-4 rounded-[28px] shadow-lg shadow-blue-200 active:scale-95 transition-all">
                <!-- 装饰光晕 -->
                <div class="absolute -top-10 -right-10 w-20 h-20 bg-white/20 blur-2xl rounded-full group-hover:scale-150 transition-transform"></div>
                
                <span class="text-sm font-black text-white flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2L14.4 9.6H22L15.8 14.2L18.2 21.8L12 17.2L5.8 21.8L8.2 14.2L2 9.6H9.6L12 2Z" />
                    </svg>
                    高级 AI 下载
                </span>
                <span class="text-[9px] text-white/70 font-medium">图生图深度二创</span>
            </button>
        </div>
        <p class="text-center text-[10px] text-gray-400 font-medium">高级下载将消耗 1 点积分，生成结果将自动保存至作品库</p>
    </div>

</div>

<script>
    console.log('素材详情页脚本加载成功');
    
    // 完全复制主页轮播图逻辑
    document.addEventListener('DOMContentLoaded', () => {
        console.log('=== 开始初始化轮播图 ===');
        
        // 轮播图逻辑
        const wrapper = document.getElementById('carousel-wrapper');
        const track = document.getElementById('carousel-track');
        const dotsContainer = document.getElementById('carousel-dots');
        const dots = dotsContainer ? dotsContainer.children : [];
        const originalSlides = Array.from(track.children);
        const slideCount = originalSlides.length;
        
        console.log('wrapper:', wrapper);
        console.log('track:', track);
        console.log('slideCount:', slideCount);
        console.log('wrapper.offsetWidth:', wrapper.offsetWidth);
        
        if (slideCount <= 1) {
            console.log('只有一张图片，不需要轮播');
            return;
        }
        
        const firstClone = originalSlides[0].cloneNode(true);
        const lastClone = originalSlides[slideCount - 1].cloneNode(true);
        
        track.appendChild(firstClone); 
        track.insertBefore(lastClone, track.firstChild); 

        const getStepWidth = () => wrapper.offsetWidth;
        let step = getStepWidth();
        console.log('step:', step);
        
        let currentIndex = 1; 
        let startX = 0;
        let currentTranslate = -currentIndex * step;
        let prevTranslate = currentTranslate;
        let isDragging = false;
        let autoPlayTimer;

        function setTransform(x) {
            track.style.transform = `translateX(${x}px)`;
        }

        function updateDots() {
            if (!dotsContainer) return;
            let realIndex = currentIndex - 1;
            if (realIndex < 0) realIndex = slideCount - 1;
            if (realIndex >= slideCount) realIndex = 0;

            Array.from(dots).forEach((dot, i) => {
                dot.className = i === realIndex 
                    ? "w-4 h-1.5 bg-blue-600 rounded-full transition-all duration-300"
                    : "w-1.5 h-1.5 bg-gray-200 rounded-full transition-all duration-300";
            });
        }

        track.addEventListener('touchstart', (e) => {
            stopAuto();
            startX = e.touches[0].clientX;
            isDragging = true;
            track.style.transition = 'none';
        });

        track.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const diff = e.touches[0].clientX - startX;
            currentTranslate = prevTranslate + diff;
            setTransform(currentTranslate);
        });

        track.addEventListener('touchend', (e) => {
            isDragging = false;
            const movedBy = currentTranslate - prevTranslate;

            if (movedBy < -step / 10) currentIndex++;
            else if (movedBy > step / 10) currentIndex--;

            scrollToIndex();
            startAuto();
        });

        function scrollToIndex(animated = true) {
            track.style.transition = animated ? 'transform 0.4s cubic-bezier(0.25, 1, 0.35, 1)' : 'none';
            currentTranslate = -currentIndex * step;
            setTransform(currentTranslate);
            prevTranslate = currentTranslate;
            updateDots();

            if (animated) {
                setTimeout(() => {
                    if (currentIndex === 0) {
                        currentIndex = slideCount;
                        scrollToIndex(false);
                    }
                    if (currentIndex === slideCount + 1) {
                        currentIndex = 1;
                        scrollToIndex(false);
                    }
                }, 400);
            }
        }

        function startAuto() {
            stopAuto();
            autoPlayTimer = setInterval(() => {
                currentIndex++;
                scrollToIndex();
            }, 4000);
        }

        function stopAuto() {
            clearInterval(autoPlayTimer);
        }

        setTransform(currentTranslate);
        updateDots();
        startAuto();
        console.log('轮播图初始化完成');
        
        window.addEventListener('resize', () => {
            step = getStepWidth();
            currentTranslate = -currentIndex * step;
            prevTranslate = currentTranslate;
            setTransform(currentTranslate);
        });
    });

    // 收藏交互
    function toggleAction(type) {
        const btn = document.getElementById('collect-btn');
        const icon = document.getElementById('collect-icon');
        const isActive = btn.classList.contains('bg-orange-500');

        if (!isActive) {
            btn.classList.replace('bg-white', 'bg-orange-500');
            btn.classList.add('text-white');
            icon.setAttribute('fill', 'currentColor');
            icon.classList.replace('text-gray-400', 'text-white');
        } else {
            btn.classList.replace('bg-orange-500', 'bg-white');
            btn.classList.remove('text-white');
            icon.setAttribute('fill', 'none');
            icon.classList.replace('text-white', 'text-gray-400');
        }
    }
</script>
{% endblock %}
