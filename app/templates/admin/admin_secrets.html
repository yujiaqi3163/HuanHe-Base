{% extends "admin/admin_base.html" %}

{% block admin_content %}
<div class="px-4 py-6 space-y-6">
    
    <!-- 1. é¡µé¢å¤´éƒ¨ä¸æœç´¢ -->
    <div class="space-y-4">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-900">å¡å¯†ç®¡ç†</h2>
            <div class="flex items-center gap-2">
                <span class="block text-xs text-gray-400">æœªä½¿ç”¨: {{ unused_count }}</span>
                {% if released_count > 0 %}
                <span class="block text-xs text-red-500">å·²é‡Šæ”¾: {{ released_count }}</span>
                {% endif %}
                <span class="block text-[10px] text-blue-500 font-bold">æ€»è®¡: {{ total_count }}</span>
                <button onclick="deleteReleasedSecrets()" class="bg-red-600 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm active:scale-95 transition-transform flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    ä¸€é”®æ¸…ç†
                </button>
            </div>
        </div>
        
        <div class="flex gap-2">
            <div class="relative flex-grow">
                <form method="get" action="{{ url_for('admin.secrets') }}">
                    <input type="text" name="search" placeholder="æœç´¢å¡å¯†æˆ–ç”¨æˆ·æ˜µç§°..." 
                        class="w-full bg-white border border-gray-200 rounded-2xl py-3 pl-10 pr-4 text-sm focus:ring-2 focus:ring-blue-500/10 outline-none transition-all"
                        value="{{ request.args.get('search', '') }}">
                    {% if status_filter %}
                    <input type="hidden" name="status" value="{{ status_filter }}">
                    {% endif %}
                    <div class="absolute left-3.5 top-3.5 text-gray-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                </form>
            </div>
            <button class="bg-gray-900 text-white px-4 rounded-2xl shadow-sm active:scale-95 transition-transform flex items-center gap-2" onclick="toggleModal('generate-modal')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                <span class="text-xs font-bold whitespace-nowrap">æ–°å¢å¡å¯†</span>
            </button>
        </div>
    </div>

    <!-- 2. çŠ¶æ€ç­›é€‰ -->
    <div class="flex gap-2 overflow-x-auto no-scrollbar py-1">
        <button class="flex-shrink-0 px-4 py-2 {% if not status_filter or status_filter == '' %}bg-blue-600 text-white shadow-md shadow-blue-100{% else %}bg-white text-gray-500 border border-gray-100{% endif %} rounded-xl text-xs font-bold transition-colors" onclick="filterSecrets('')">å…¨éƒ¨</button>
        <button class="flex-shrink-0 px-4 py-2 {% if status_filter == 'unused' %}bg-blue-600 text-white shadow-md shadow-blue-100{% else %}bg-white text-gray-500 border border-gray-100{% endif %} rounded-xl text-xs font-medium transition-colors" onclick="filterSecrets('unused')">æœªä½¿ç”¨</button>
        <button class="flex-shrink-0 px-4 py-2 {% if status_filter == 'used' %}bg-blue-600 text-white shadow-md shadow-blue-100{% else %}bg-white text-gray-500 border border-gray-100{% endif %} rounded-xl text-xs font-medium transition-colors" onclick="filterSecrets('used')">å·²ä½¿ç”¨</button>
        <button class="flex-shrink-0 px-4 py-2 {% if status_filter == 'expired' %}bg-blue-600 text-white shadow-md shadow-blue-100{% else %}bg-white text-gray-500 border border-gray-100{% endif %} rounded-xl text-xs font-medium transition-colors" onclick="filterSecrets('expired')">å·²å¤±æ•ˆ</button>
    </div>

    <!-- 3. å¡å¯†åˆ—è¡¨ -->
    <div class="space-y-3">
        {% for secret in secrets %}
        <div class="{% if secret.is_used and not secret.user_id %}bg-red-50/50{% elif secret.is_used %}bg-gray-50/50{% else %}bg-white{% endif %} rounded-3xl border border-gray-100 p-4 shadow-sm relative overflow-hidden">
            <div class="flex justify-between items-start mb-3 {% if secret.is_used and not secret.user_id %}opacity-70{% elif secret.is_used %}opacity-60{% endif %}">
                <div>
                    <span class="text-[10px] font-bold {% if secret.is_used and not secret.user_id %}text-red-400 bg-red-50{% elif secret.is_used %}text-gray-400 bg-gray-100{% else %}text-blue-600 bg-blue-50{% endif %} px-2 py-0.5 rounded-full uppercase mb-1 inline-block">
                        {% if secret.is_used and not secret.user_id %}å·²é‡Šæ”¾{% elif secret.is_used %}å·²ä½¿ç”¨{% else %}æœªä½¿ç”¨{% endif %}
                    </span>
                    <h3 class="text-sm font-mono font-bold {% if secret.is_used and not secret.user_id %}text-red-500 line-through{% elif secret.is_used %}text-gray-500 line-through{% else %}text-gray-800{% endif %}">{{ secret.secret }}</h3>
                </div>
                <div class="text-right">
                    {% if secret.is_used and secret.user %}
                    <p class="text-[10px] text-gray-400 font-medium leading-tight">ä½¿ç”¨è€…: {{ secret.user.username }}</p>
                    {% elif secret.is_used and not secret.user %}
                    <p class="text-[10px] text-red-400 font-medium leading-tight">å·²é‡Šæ”¾</p>
                    {% endif %}
                    <p class="text-[10px] text-gray-400 font-medium leading-tight">
                        {% if secret.duration_type == '1min' %}1åˆ†é’Ÿå¡
                        {% elif secret.duration_type == '1day' %}æ—¥å¡(1å¤©)
                        {% elif secret.duration_type == '1month' %}æœˆå¡(1ä¸ªæœˆ)
                        {% elif secret.duration_type == '1year' %}å¹´å¡(1å¹´)
                        {% elif secret.duration_type == 'permanent' %}æ°¸ä¹…å¡
                        {% else %}æ³¨å†Œå¡å¯†
                        {% endif %}
                    </p>
                    {% if secret.is_used and secret.used_at %}
                    <p class="text-[10px] text-gray-300 mt-0.5">å…‘æ¢æ—¶é—´: {{ secret.used_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    {% endif %}
                    {% if secret.expires_at %}
                        {% if secret.is_used %}
                            {% if secret.duration_type != 'permanent' %}
                                {% if now > secret.expires_at %}
                                    <p class="text-[10px] text-red-500 mt-0.5 font-bold">å·²å¤±æ•ˆ</p>
                                {% else %}
                                    <p class="text-[10px] text-green-500 mt-0.5 font-bold">ä½¿ç”¨ä¸­</p>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        <p class="text-[10px] {% if secret.is_used and now > secret.expires_at and secret.duration_type != 'permanent' %}text-red-400{% else %}text-orange-400{% endif %} mt-0.5">
                            è¿‡æœŸæ—¶é—´: {{ secret.expires_at.strftime('%Y-%m-%d %H:%M') }}
                        </p>
                    {% elif not secret.is_used and secret.created_at %}
                        <p class="text-[10px] text-gray-300 mt-0.5">ç”Ÿæˆæ—¶é—´: {{ secret.created_at.strftime('%Y-%m-%d') }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="flex items-center justify-between pt-3 border-t border-dashed {% if secret.is_used and not secret.user_id %}border-red-200/50{% elif secret.is_used %}border-gray-200/50{% else %}border-gray-50{% endif %}">
                {% if secret.is_used and secret.user %}
                <span class="text-[10px] text-gray-400 italic">è¯¥å¡å¯†å·²æ ¸é”€</span>
                <div class="flex gap-2">
                    <button class="p-2 rounded-xl bg-red-50 text-red-600 active:bg-red-100" onclick="releaseSecret({{ secret.id }})">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                    </button>
                </div>
                {% elif secret.is_used and not secret.user %}
                <span class="text-[10px] text-red-400 italic">è¯¥å¡å¯†å·²é‡Šæ”¾ï¼Œå¯ä»¥åˆ é™¤</span>
                <div class="flex gap-2">
                    <button class="p-2 rounded-xl bg-red-50 text-red-600 active:bg-red-100" onclick="deleteSecret({{ secret.id }})">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>
                {% else %}
                <span class="text-[10px] text-gray-400 italic">ç”Ÿæˆäº {{ secret.created_at.strftime('%Y-%m-%d') }}</span>
                <div class="flex gap-2">
                    <button class="p-2 rounded-xl bg-gray-50 text-gray-400 active:bg-red-50 active:text-red-600" onclick="deleteSecret({{ secret.id }})">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="text-center py-12 text-gray-400">
            <p class="text-sm">æš‚æ— å¡å¯†æ•°æ®</p>
        </div>
        {% endfor %}
    </div>

    <!-- 4. åŠ è½½æ›´å¤šæŒ‰é’® -->
    <button class="w-full py-4 text-gray-400 text-xs font-medium italic underline underline-offset-4">æŸ¥çœ‹å†å²è¿‡æœŸå¡å¯†</button>

</div>

<!-- æ‰¹é‡ç”Ÿæˆå¡å¯†å¼¹çª— (Generate Keys Modal) -->
<div id="generate-modal" class="fixed inset-0 z-[100] hidden overflow-hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleModal('generate-modal')"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[40px] max-h-[90vh] overflow-y-auto no-scrollbar shadow-2xl transition-transform duration-300 transform translate-y-0 p-8 space-y-6">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto -mt-2 mb-4"></div>
        
        <header class="text-center">
            <h3 class="text-xl font-bold text-gray-900">æ‰¹é‡ç”Ÿæˆå¡å¯†</h3>
            <p class="text-xs text-gray-400 mt-1">ç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„åŠ å¯†å­—ç¬¦ä¸²</p>
        </header>

        <div id="generate-content" class="space-y-4 pb-8">
            <div id="generate-form" class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-400 ml-4 uppercase">å¡å¯†ç±»å‹</label>
                    <select id="duration-type" class="w-full px-5 py-4 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-blue-500/20 outline-none text-sm appearance-none">
                        <option value="1min">1åˆ†é’Ÿå¡ (æµ‹è¯•ç”¨)</option>
                        <option value="1day">æ—¥å¡ (1å¤©)</option>
                        <option value="1month">æœˆå¡ (1ä¸ªæœˆ)</option>
                        <option value="1year">å¹´å¡ (1å¹´)</option>
                        <option value="permanent">æ°¸ä¹…å¡</option>
                    </select>
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-400 ml-4 uppercase">ç”Ÿæˆæ•°é‡</label>
                    <input type="number" id="secret-count" value="1" min="1" max="100" class="w-full px-5 py-4 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-blue-500/20 outline-none text-sm">
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" class="flex-grow py-4 bg-gray-100 text-gray-500 font-bold rounded-2xl active:scale-95 transition-transform" onclick="toggleModal('generate-modal')">å–æ¶ˆ</button>
                    <button type="button" id="generate-btn" class="flex-grow py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg shadow-blue-100 active:scale-95 transition-transform" onclick="generateSecrets()">ç«‹å³ç”Ÿæˆ</button>
                </div>
            </div>

            <div id="generate-result" class="hidden space-y-4">
                <div class="text-center py-4">
                    <div class="text-4xl mb-2">ğŸ‰</div>
                    <h4 class="text-lg font-bold text-gray-900">ç”ŸæˆæˆåŠŸï¼</h4>
                    <p id="result-message" class="text-xs text-gray-400 mt-1"></p>
                </div>
                <div class="bg-gray-50 rounded-2xl p-4 max-h-60 overflow-y-auto">
                    <div id="result-secrets" class="space-y-2 text-sm font-mono"></div>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" class="flex-grow py-4 bg-gray-100 text-gray-500 font-bold rounded-2xl active:scale-95 transition-transform" onclick="closeGenerateModal()">å…³é—­</button>
                    <button type="button" id="copy-btn" class="flex-grow py-4 bg-green-600 text-white font-bold rounded-2xl shadow-lg shadow-green-100 active:scale-95 transition-transform" onclick="copySecrets()">å¤åˆ¶å…¨éƒ¨</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let generatedSecrets = [];
    let searchTimer = null;

    function toggleModal(id) {
        const modal = document.getElementById(id);
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            if (id === 'generate-modal') {
                resetGenerateModal();
            }
        } else {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    }

    // æœç´¢è¾“å…¥æ¡†é˜²æŠ–
    function initSearchInput() {
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(function() {
                    const form = searchInput.closest('form');
                    if (form) {
                        form.submit();
                    }
                }, 300);
            });
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initSearchInput();
    });

    function resetGenerateModal() {
        document.getElementById('generate-form').classList.remove('hidden');
        document.getElementById('generate-result').classList.add('hidden');
        document.getElementById('duration-type').value = 'permanent';
        document.getElementById('secret-count').value = '1';
        generatedSecrets = [];
    }

    function closeGenerateModal() {
        toggleModal('generate-modal');
        window.location.reload();
    }

    function generateSecrets() {
        const durationType = document.getElementById('duration-type').value;
        const count = document.getElementById('secret-count').value;
        const btn = document.getElementById('generate-btn');

        btn.disabled = true;
        btn.textContent = 'ç”Ÿæˆä¸­...';

        fetch('/admin/api/secrets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                duration_type: durationType,
                count: count
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            return response.json().then(err => Promise.reject(err));
        })
        .then(data => {
            if (data.success) {
                generatedSecrets = data.data.secrets;
                showGenerateResult(data);
            } else {
                alert(data.message || 'ç”Ÿæˆå¤±è´¥');
                btn.disabled = false;
                btn.textContent = 'ç«‹å³ç”Ÿæˆ';
            }
        })
        .catch(error => {
            alert(error.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            btn.disabled = false;
            btn.textContent = 'ç«‹å³ç”Ÿæˆ';
        });
    }

    function showGenerateResult(data) {
        document.getElementById('generate-form').classList.add('hidden');
        document.getElementById('generate-result').classList.remove('hidden');

        document.getElementById('result-message').textContent = data.message;

        const secretsContainer = document.getElementById('result-secrets');
        secretsContainer.innerHTML = '';
        
        data.data.secrets.forEach(secret => {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-xl px-3 py-2 text-gray-700 select-all';
            div.textContent = secret;
            secretsContainer.appendChild(div);
        });
    }

    function copySecrets() {
        const text = generatedSecrets.join('\n');
        
        // æ–¹æ³•1: å°è¯•ä½¿ç”¨ç°ä»£çš„ Clipboard API
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess();
            }).catch(err => {
                // å¤±è´¥æ—¶å°è¯•ä¼ ç»Ÿæ–¹æ³•
                fallbackCopyText(text);
            });
        } else {
            // æ–¹æ³•2: ä½¿ç”¨ä¼ ç»Ÿçš„ execCommand æ–¹æ³•
            fallbackCopyText(text);
        }
    }
    
    function fallbackCopyText(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopySuccess();
            } else {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        } catch (err) {
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        }
        
        document.body.removeChild(textArea);
    }
    
    function showCopySuccess() {
        const btn = document.getElementById('copy-btn');
        btn.textContent = 'å·²å¤åˆ¶ï¼';
        btn.classList.remove('bg-green-600', 'shadow-green-100');
        btn.classList.add('bg-gray-600', 'shadow-gray-100');
        
        setTimeout(() => {
            btn.textContent = 'å¤åˆ¶å…¨éƒ¨';
            btn.classList.remove('bg-gray-600', 'shadow-gray-100');
            btn.classList.add('bg-green-600', 'shadow-green-100');
        }, 2000);
    }

    function deleteSecret(secretId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¡å¯†å—ï¼Ÿ')) {
            return;
        }

        fetch(`/admin/api/secrets/${secretId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            return response.json().then(err => Promise.reject(err));
        })
        .then(data => {
            if (data.success) {
                alert('åˆ é™¤æˆåŠŸ');
                window.location.reload();
            } else {
                alert(data.message || 'åˆ é™¤å¤±è´¥');
            }
        })
        .catch(error => {
            alert(error.message || 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
    
    function deleteReleasedSecrets() {
        if (!confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰å·²é‡Šæ”¾çš„å¡å¯†å—ï¼Ÿ\n\nå·²é‡Šæ”¾çš„å¡å¯†æ˜¯æŒ‡ç”¨æˆ·ç»­è´¹åä¸å†ä½¿ç”¨çš„è¿‡æœŸå¡å¯†ã€‚')) {
            return;
        }

        fetch('/admin/api/secrets/delete-released', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            return response.json().then(err => Promise.reject(err));
        })
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert(data.message || 'åˆ é™¤å¤±è´¥');
            }
        })
        .catch(error => {
            alert(error.message || 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
    
    function releaseSecret(secretId) {
        if (!confirm('âš ï¸ è­¦å‘Šï¼æ­¤æ“ä½œéå¸¸å±é™©ï¼\n\né‡Šæ”¾åï¼Œè¯¥å¡å¯†å°†ä»ç”¨æˆ·è´¦æˆ·ä¸­ç§»é™¤ï¼Œç”¨æˆ·å°†å¤±å»ä¼šå‘˜æƒé™ã€‚\n\nç¡®å®šè¦é‡Šæ”¾è¿™ä¸ªå¡å¯†å—ï¼Ÿ')) {
            return;
        }

        fetch(`/admin/api/secrets/${secretId}/release`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            return response.json().then(err => Promise.reject(err));
        })
        .then(data => {
            if (data.success) {
                alert('é‡Šæ”¾æˆåŠŸ');
                window.location.reload();
            } else {
                alert(data.message || 'é‡Šæ”¾å¤±è´¥');
            }
        })
        .catch(error => {
            alert(error.message || 'é‡Šæ”¾å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
    
    function filterSecrets(status) {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('status', status);
        currentUrl.searchParams.delete('page');
        window.location.href = currentUrl.toString();
    }
</script>
{% endblock %}