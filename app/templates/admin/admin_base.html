<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>管理后台 - 幻核矩阵</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* 页面平滑载入动画 */
        .page-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 统一返回按钮样式 */
        .back-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: white;
            border: 1px solid #f3f4f6;
            border-radius: 16px;
            color: #9ca3af;
            transition: all 0.2s ease;
        }
        .back-button:active {
            transform: scale(0.92);
            background: #f9fafb;
        }
        
        /* 统一输入框样式 */
        .form-input {
            width: 100%;
            padding: 16px 24px;
            background: #f9fafb;
            border: none;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .form-input:focus {
            background: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        .form-input::placeholder {
            color: #d1d5db;
            font-weight: 500;
        }
        
        /* 统一卡片样式 */
        .content-card {
            background: white;
            border-radius: 32px;
            border: 1px solid #f3f4f6;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        /* 统一按钮样式 */
        .btn-primary {
            background: #111827;
            color: white;
            font-weight: 700;
            border-radius: 20px;
            transition: all 0.2s ease;
        }
        .btn-primary:active {
            transform: scale(0.95);
        }
        .btn-secondary {
            background: #f9fafb;
            color: #9ca3af;
            font-weight: 700;
            border-radius: 20px;
            transition: all 0.2s ease;
        }
        .btn-secondary:active {
            transform: scale(0.95);
            background: #f3f4f6;
        }
        
        /* 统一提示框/Toast样式 */
        .toast-container {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .toast {
            margin-bottom: 8px;
            padding: 12px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            border: 1px solid;
        }
        .toast-success {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #166534;
        }
        .toast-error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #991b1b;
        }
        .toast-info {
            background: #eff6ff;
            border-color: #bfdbfe;
            color: #1e40af;
        }
        
        /* 统一弹窗样式 */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .modal-content {
            background: white;
            border-radius: 32px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-body {
            padding: 24px;
        }
        .modal-footer {
            padding: 24px;
            padding-top: 0;
            display: flex;
            gap: 12px;
        }
        .modal-close-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: #f3f4f6;
            border-radius: 50%;
            color: #9ca3af;
            transition: all 0.2s ease;
        }
        .modal-close-btn:hover {
            background: #e5e7eb;
            color: #6b7280;
        }
        
        /* 统一标签样式 */
        .section-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 8px;
        }
        .section-label-dot {
            width: 4px;
            height: 12px;
            background: #2563eb;
            border-radius: 9999px;
        }
        .section-label-text {
            font-size: 10px;
            font-weight: 900;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        /* 侧边栏菜单样式 */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 85%;
            max-width: 320px;
            background: linear-gradient(180deg, #f9fafb 0%, #ffffff 100%);
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .sidebar.active {
            transform: translateX(0);
        }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            margin: 4px 12px;
            border-radius: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .menu-item:hover {
            background: #f3f4f6;
        }
        .menu-item.active {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
        }
        .menu-section-title {
            font-size: 11px;
            font-weight: 900;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 20px 20px 8px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen pb-28">

    <!-- 侧边栏遮罩 -->
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- 侧边栏菜单 -->
    <div id="sidebar" class="sidebar">
        <!-- 侧边栏头部 -->
        <div class="bg-gradient-to-r from-gray-900 to-gray-800 px-6 py-8">
            <div class="flex items-center gap-3 mb-2">
                <div class="relative flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
                </div>
                <h2 class="text-lg font-black text-white">Admin Console</h2>
            </div>
            <p class="text-xs text-gray-400 font-medium">Management System</p>
            {% if current_user.is_authenticated %}
            <div class="mt-4 flex items-center gap-2 bg-white/10 px-3 py-2 rounded-xl">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                    <span class="text-white text-sm font-bold">{{ current_user.username[0]|upper if current_user.username else 'A' }}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-white truncate">{{ current_user.username }}</p>
                    <p class="text-[10px] text-gray-400">
                        {% if current_user.is_super_admin %}超级管理员{% else %}管理员{% endif %}
                    </p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- 菜单内容 -->
        <div class="flex-1 overflow-y-auto py-4 safe-area-bottom">
            <!-- 数据概览 -->
            <p class="menu-section-title">数据概览</p>
            <a href="{{ url_for('admin.index') }}" class="menu-item {% if request.endpoint == 'admin.index' %}active{% endif %}" onclick="closeSidebar()">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-sm">数据统计</p>
                    <p class="text-[10px] text-gray-400">查看平台数据概览</p>
                </div>
                {% if request.endpoint == 'admin.index' %}
                <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                {% endif %}
            </a>

            <!-- 素材管理 -->
            {% if current_user.is_super_admin or current_user.has_permission('material_manage') or current_user.has_permission('type_manage') %}
            <p class="menu-section-title mt-2">素材管理</p>
            {% if current_user.is_super_admin or current_user.has_permission('material_manage') %}
            <a href="{{ url_for('admin.materials') }}" class="menu-item {% if request.endpoint == 'admin.materials' %}active{% endif %}" onclick="closeSidebar()">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-sm">素材列表</p>
                    <p class="text-[10px] text-gray-400">管理所有素材</p>
                </div>
                {% if request.endpoint == 'admin.materials' %}
                <div class="w-2 h-2 rounded-full bg-purple-500"></div>
                {% endif %}
            </a>
            <a href="{{ url_for('admin.material_add') }}" class="menu-item {% if request.endpoint == 'admin.material_add' %}active{% endif %}" onclick="closeSidebar()">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-sm">添加素材</p>
                    <p class="text-[10px] text-gray-400">上传新素材</p>
                </div>
                {% if request.endpoint == 'admin.material_add' %}
                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                {% endif %}
            </a>
            {% endif %}
            {% if current_user.is_super_admin or current_user.has_permission('type_manage') %}
            <a href="{{ url_for('admin.material_types') }}" class="menu-item {% if request.endpoint == 'admin.material_types' %}active{% endif %}" onclick="closeSidebar()">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-sm">分类管理</p>
                    <p class="text-[10px] text-gray-400">管理素材分类</p>
                </div>
                {% if request.endpoint == 'admin.material_types' %}
                <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                {% endif %}
            </a>
            {% endif %}
            {% endif %}

            <!-- 用户管理 -->
            {% if current_user.is_super_admin or current_user.has_permission('user_manage') %}
            <p class="menu-section-title mt-2">用户管理</p>
            <a href="{{ url_for('admin.users') }}" class="menu-item {% if request.endpoint == 'admin.users' %}active{% endif %}" onclick="closeSidebar()">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-sm">用户列表</p>
                    <p class="text-[10px] text-gray-400">管理所有用户</p>
                </div>
                {% if request.endpoint == 'admin.users' %}
                <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                {% endif %}
            </a>
            {% endif %}

            <!-- 系统设置 -->
            {% if current_user.is_super_admin or current_user.has_permission('secret_manage') or current_user.has_permission('config_manage') %}
            <p class="menu-section-title mt-2">系统设置</p>
            {% if current_user.is_super_admin or current_user.has_permission('config_manage') %}
            <a href="{{ url_for('admin.announcements') }}" class="menu-item {% if request.endpoint == 'admin.announcements' or request.endpoint == 'admin.announcement_add' or request.endpoint == 'admin.announcement_edit' %}active{% endif %}" onclick="closeSidebar()">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.999 3.999 0 00-1.564.317z" />
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-sm">公告管理</p>
                    <p class="text-[10px] text-gray-400">管理网站公告</p>
                </div>
                {% if request.endpoint == 'admin.announcements' or request.endpoint == 'admin.announcement_add' or request.endpoint == 'admin.announcement_edit' %}
                <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                {% endif %}
            </a>
            <button onclick="showWechatModal(); closeSidebar();" class="menu-item w-full text-left">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-sm">设置客服微信</p>
                    <p class="text-[10px] text-gray-400">设置客服联系方式</p>
                </div>
            </button>
            {% endif %}
            {% if current_user.is_super_admin or current_user.has_permission('secret_manage') %}
            <a href="{{ url_for('admin.secrets') }}" class="menu-item {% if request.endpoint == 'admin.secrets' %}active{% endif %}" onclick="closeSidebar()">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-pink-500 to-pink-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-sm">卡密管理</p>
                    <p class="text-[10px] text-gray-400">管理注册卡密</p>
                </div>
                {% if request.endpoint == 'admin.secrets' %}
                <div class="w-2 h-2 rounded-full bg-pink-500"></div>
                {% endif %}
            </a>
            {% endif %}
            {% endif %}

            <!-- 分割线 -->
            <div class="h-px bg-gray-200 mx-6 my-4"></div>

            <!-- 网站首页 -->
            <a href="/" class="menu-item" onclick="closeSidebar()">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-gray-500 to-gray-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-sm">返回网站</p>
                    <p class="text-[10px] text-gray-400">访问前台首页</p>
                </div>
            </a>
        </div>
    </div>

    <!-- 消息闪现区域 -->
    <div id="flash-messages" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] flex flex-col items-center">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message mb-2 px-5 py-3 rounded-xl shadow-lg border text-sm text-center inline-block {% if category == 'success' %}bg-green-50 border-green-200 text-green-700{% elif category == 'danger' %}bg-red-50 border-red-200 text-red-700{% elif category == 'info' %}bg-blue-50 border-blue-200 text-blue-700{% else %}bg-gray-50 border-gray-200 text-gray-700{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- 1. 顶部标题栏 -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-gray-100 px-5 py-4 flex items-center gap-3">
        <!-- 菜单按钮 -->
        <button onclick="openSidebar()" class="back-button">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>
        
        <!-- 标题 -->
        <div class="flex-1">
            <h1 class="text-sm font-black tracking-tight text-gray-900 uppercase">
                {% if request.endpoint == 'admin.index' %}数据统计
                {% elif request.endpoint == 'admin.materials' %}素材列表
                {% elif request.endpoint == 'admin.material_add' or request.endpoint == 'admin.material_edit' %}添加素材
                {% elif request.endpoint == 'admin.material_types' %}分类管理
                {% elif request.endpoint == 'admin.users' %}用户列表
                {% elif request.endpoint == 'admin.announcements' %}公告列表
                {% elif request.endpoint == 'admin.announcement_add' or request.endpoint == 'admin.announcement_edit' %}编辑公告
                {% elif request.endpoint == 'admin.secrets' %}卡密管理
                {% else %}管理后台{% endif %}
            </h1>
            <p class="text-[8px] text-gray-400 font-bold uppercase tracking-widest leading-none mt-0.5">Management Console</p>
        </div>
        
        <!-- 管理员标识 -->
        <div class="flex items-center gap-2 bg-blue-50 px-2.5 py-1 rounded-full border border-blue-100">
            <span class="text-[9px] font-black text-blue-600 uppercase tracking-tighter">Admin</span>
        </div>
    </header>

    <!-- 2. 主体内容 -->
    <main class="max-w-md mx-auto page-fade-in">
        {% block admin_content %}{% endblock %}
    </main>

    <script>
        // 打开侧边栏
        function openSidebar() {
            document.getElementById('sidebar-overlay').classList.add('active');
            document.getElementById('sidebar').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭侧边栏
        function closeSidebar() {
            document.getElementById('sidebar-overlay').classList.remove('active');
            document.getElementById('sidebar').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // 消息自动消失
        document.addEventListener('DOMContentLoaded', function() {
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(function(message, index) {
                setTimeout(function() {
                    message.style.transition = 'opacity 0.5s, transform 0.5s';
                    message.style.opacity = '0';
                    message.style.transform = 'translateY(-10px)';
                    setTimeout(function() {
                        message.remove();
                    }, 500);
                }, 5000 + index * 500);
            });
        });
    </script>

    <!-- 设置客服微信弹出框 -->
    {% if current_user.is_super_admin or current_user.has_permission('config_manage') %}
    <div id="wechat-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <!-- 背景遮罩 -->
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="hideWechatModal()"></div>
        
        <!-- 弹出框内容 -->
        <div class="relative bg-white rounded-[32px] p-6 w-full max-w-[380px] shadow-2xl max-h-[90vh] overflow-y-auto">
            <!-- 关闭按钮 -->
            <button onclick="hideWechatModal()" class="absolute top-4 right-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <!-- 标题 -->
            <h3 class="text-xl font-black text-gray-800 mb-4">设置客服微信</h3>
            
            <!-- 输入框 -->
            <div class="space-y-4">
                <div class="relative">
                    <label class="block text-xs font-bold text-gray-500 mb-2">客服微信号</label>
                    <input type="text" id="wechat-input" value="{{ customer_service_wechat }}" placeholder="请输入客服微信号"
                        class="w-full pl-4 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500/20 focus:border-orange-400 focus:bg-white outline-none transition-all text-sm">
                </div>
                
                <div class="relative">
                    <label class="block text-xs font-bold text-gray-500 mb-2">客服微信二维码</label>
                    
                    <!-- 二维码预览 -->
                    <div id="qrcode-preview" class="mb-3">
                        {% if customer_service_qrcode %}
                        <div class="relative bg-gray-50 rounded-xl p-3">
                            <img src="{{ customer_service_qrcode }}" alt="客服二维码" class="w-full max-w-[200px] mx-auto rounded-lg">
                            <button type="button" onclick="deleteQrcode()" class="absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition-colors">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- 上传区域 -->
                    <div class="relative">
                        <input type="file" id="qrcode-input" accept="image/*" onchange="previewQrcode(event)" class="hidden">
                        <label for="qrcode-input" class="w-full flex flex-col items-center justify-center py-4 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:border-orange-400 hover:bg-orange-50 transition-all">
                            <svg class="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span class="text-sm text-gray-500">点击上传二维码图片</span>
                        </label>
                    </div>
                </div>
                
                <!-- 保存按钮 -->
                <button onclick="saveWechat()" class="w-full py-3 bg-gradient-to-r from-orange-500 to-amber-500 text-white font-bold rounded-xl shadow-lg shadow-orange-200 active:scale-[0.98] transition-all">
                    保存设置
                </button>
            </div>
        </div>
    </div>

    <script>
        function showWechatModal() {
            const modal = document.getElementById('wechat-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function hideWechatModal() {
            const modal = document.getElementById('wechat-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = '';
            }
        }
        
        function previewQrcode(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.getElementById('qrcode-preview');
                    previewDiv.innerHTML = `
                        <div class="relative bg-gray-50 rounded-xl p-3">
                            <img src="${e.target.result}" alt="二维码预览" class="w-full max-w-[200px] mx-auto rounded-lg">
                            <button type="button" onclick="deleteQrcode()" class="absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition-colors">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        }
        
        async function deleteQrcode() {
            if (!confirm('确定要删除二维码吗？')) {
                return;
            }
            
            try {
                const response = await fetch('/admin/config/wechat-qrcode', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('qrcode-preview').innerHTML = '';
                    document.getElementById('qrcode-input').value = '';
                    window.location.reload();
                } else {
                    alert('删除失败：' + result.message);
                }
            } catch (error) {
                console.error('删除失败:', error);
                alert('删除失败，请重试');
            }
        }
        
        async function saveWechat() {
            const wechatInput = document.getElementById('wechat-input');
            if (!wechatInput) {
                alert('您没有权限执行此操作');
                return;
            }
            const wechat = wechatInput.value.trim();
            if (!wechat) {
                alert('请输入客服微信号');
                return;
            }
            
            const formData = new FormData();
            formData.append('wechat', wechat);
            
            const qrcodeInput = document.getElementById('qrcode-input');
            if (qrcodeInput && qrcodeInput.files.length > 0) {
                formData.append('qrcode', qrcodeInput.files[0]);
            }
            
            try {
                const response = await fetch('/admin/config/wechat', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('保存成功！');
                    hideWechatModal();
                    window.location.reload();
                } else {
                    alert('保存失败：' + result.message);
                }
            } catch (error) {
                console.error('保存失败:', error);
                alert('保存失败，请重试');
            }
        }
    </script>
    {% endif %}

</body>
</html>
