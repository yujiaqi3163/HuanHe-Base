# Flask + Tailwind CSS 移动端应用开发记录

## 项目初始化
- **日期**: 2026-02-19
- **项目目录**: `e:\Falsk Web\my_flask_app`

## 已完成工作

### 1. Flask 框架搭建
- [x] 激活虚拟环境：`.\venv\Scripts\activate`
- [x] 安装 Flask 依赖：`pip install flask`
- [x] 创建 Flask 主应用文件 `app.py`
- [x] 配置 Hello World 路由

### 2. 项目结构创建
```
my_flask_app/
├── app/                          # 应用主目录（自行编写）
│   ├── __init__.py              # 应用配置入口，包含 Config 类、db 初始化、应用工厂函数（自行编写）
│   ├── templates/                # HTML 模板目录（自行编写）
│   │   ├── base.html           # 基础模板，包含通用布局和消息展示（自行编写）
│   │   ├── index.html          # 首页模板，展示用户列表和卡密列表（自行编写）
│   │   └── auth/               # 认证相关模板目录（自行编写）
│   │       ├── login.html      # 登录页面模板（自行编写）
│   │       └── register.html   # 注册页面模板（自行编写）
│   ├── static/                   # 静态资源目录（自行编写）
│   │   ├── css/                 # 编译后的 CSS
│   │   │   └── output.css      # Tailwind 编译后的 CSS 文件（编译生成）
│   │   └── src/                 # Tailwind 源文件
│   │       └── input.css       # Tailwind 源文件，包含 @tailwind 指令（自行编写）
│   ├── models/                   # 数据模型目录（自行编写）
│   │   ├── __init__.py          # 模型包初始化，导出 User 和 RegisterSecret 模型（自行编写）
│   │   ├── user.py              # User 用户模型，包含用户信息、密码、角色等字段，继承 UserMixin（自行编写）
│   │   └── register_secret.py   # RegisterSecret 注册卡密模型，管理注册卡密（自行编写）
│   ├── routes/                   # 路由目录（自行编写）
│   │   ├── __init__.py          # 路由包初始化，导出 main_bp Blueprint（自行编写）
│   │   ├── main.py              # 主路由 Blueprint，定义首页等路由（自行编写）
│   │   └── auth/                # 认证路由目录（自行编写）
│   │       ├── __init__.py      # 认证路由包初始化，导出 auth_bp Blueprint（自行编写）
│   │       └── routes.py        # 认证路由，包含登录、注册、退出（自行编写）
│   └── forms/                    # 表单验证目录（自行编写）
│       ├── __init__.py          # 表单包初始化，导出 LoginForm 和 RegisterForm（自行编写）
│       └── auth.py              # 认证表单，包含 LoginForm 和 RegisterForm（自行编写）
├── run.py                        # 应用启动文件（自行编写）
├── init_db.py                    # 数据库初始化脚本，创建表并添加示例数据（自行编写）
├── instance/                     # 实例目录
│   └── app.db                  # SQLite 数据库文件（运行时生成）
├── package.json                  # npm 配置文件，包含 Tailwind 依赖和脚本（自行编写）
├── tailwind.config.js            # Tailwind CSS 配置文件（自行编写）
├── 代码大全.txt                  # 项目开发备忘（自行编写）
└── 项目开发记录.md               # 项目开发记录文档（本文件，自行编写）
```

**注：后续新增自行编写的文件时，请在此目录结构中添加相应注释说明。**

### 3. Tailwind CSS 配置
- [x] 创建 `package.json`，包含构建脚本
- [x] 创建 `tailwind.config.js`，配置内容扫描路径
- [x] 创建 Tailwind 源文件 `static/src/input.css`
- [x] 安装 Tailwind 依赖：`npm install`
- [x] 编译生成 CSS：`npm run build`

### 4. 示例页面创建
- [x] 创建 `templates/index.html`，包含响应式设计
- [x] 使用 Tailwind CSS 实现美观的 Hello World 页面
- [x] 页面采用移动端适配设计

### 5. SQL 数据库集成
- [x] 安装 Flask-SQLAlchemy 依赖：`pip install flask-sqlalchemy`
- [x] 配置 SQLite 数据库（app.db）
- [x] 创建 User 模型（id, username, email, created_at）
- [x] 创建数据库初始化脚本 `init_db.py`
- [x] 自动创建数据库表并添加示例数据
- [x] 更新 index 路由，从数据库读取用户数据
- [x] 更新 index.html 显示用户列表

### 6. 模块化重构
- [x] 创建 `config.py` 配置文件
- [x] 创建 `extensions.py` 数据库扩展初始化
- [x] 创建 `models/` 目录和 `__init__.py`
- [x] 创建 `routes/` 目录和 `__init__.py`
- [x] 重构 `app.py` 使用工厂模式
- [x] 使用 Blueprint 管理路由

### 7. 完善 User 模型
- [x] 添加 `password_hash` 字段（密码哈希）
- [x] 添加 `is_admin` 字段（管理员判定）
- [x] 添加 `is_super_admin` 字段（超级管理员判定）
- [x] 添加 `register_secret` 字段（注册卡密）
- [x] 实现密码加密和验证方法
- [x] 添加数据库索引优化查询

### 8. 创建 RegisterSecret 模型
- [x] 创建 `RegisterSecret` 模型管理注册卡密
- [x] 添加 `secret` 字段（卡密内容）
- [x] 添加 `is_used` 字段（是否已使用）
- [x] 添加 `created_at` 和 `used_at` 时间字段

### 9. 更新示例数据
- [x] 添加 4 个注册卡密
- [x] 添加 3 个示例用户（admin、demo、test）
- [x] admin 用户设为超级管理员
- [x] 标记已使用的卡密

### 10. 更新用户列表页面
- [x] 显示用户角色标签（超级管理员/管理员/普通用户）
- [x] 使用不同颜色区分用户角色
- [x] 显示注册卡密（部分隐藏）

### 11. 优化卡密模型关系
- [x] User 模型删除 register_secret 字段，添加 register_secrets 关系
- [x] RegisterSecret 模型添加 user_id 外键字段
- [x] 建立双向关联关系（backref='user'）
- [x] 更新数据库初始化脚本，正确建立关联
- [x] 添加卡密列表页面展示
- [x] 显示卡密使用状态（已使用/未使用）
- [x] 显示卡密绑定的用户信息

### 12. 用户登录注册功能开发
- [x] 安装 Flask-WTF 和 Flask-Login 依赖
- [x] 更新 User 模型，添加 UserMixin 支持 Flask-Login
- [x] 创建 forms/ 目录和 auth.py 表单模块
- [x] 创建 LoginForm，支持用户名/邮箱登录、记住密码功能
- [x] 创建 RegisterForm，包含用户名、邮箱、两次密码、注册密钥验证
- [x] 创建 routes/auth/ 目录和认证路由模块
- [x] 实现登录路由，支持用户名或邮箱登录
- [x] 实现注册路由，包含卡密验证逻辑
- [x] 实现退出登录路由
- [x] 创建基础模板 base.html，包含消息闪现
- [x] 创建登录页面模板 login.html
- [x] 创建注册页面模板 register.html
- [x] 在 app.py 中初始化 LoginManager
- [x] 实现 user_loader 回调函数
- [x] 注册 auth_bp 蓝图，url_prefix 为 /auth
- [x] 表单验证逻辑：用户名唯一性、邮箱唯一性、卡密有效性

## 数据模型说明

### User 模型字段
- `id`: 主键
- `username`: 用户名（唯一，索引）
- `email`: 邮箱（唯一，索引）
- `password_hash`: 密码哈希
- `is_admin`: 是否为管理员
- `is_super_admin`: 是否为超级管理员
- `created_at`: 创建时间
- `register_secrets`: 关系字段，关联到使用的卡密（一对多）

### RegisterSecret 模型字段
- `id`: 主键
- `secret`: 注册卡密（唯一，索引）
- `is_used`: 是否已使用
- `user_id`: 外键，关联到 User 表
- `created_at`: 创建时间
- `used_at`: 使用时间
- `user`: 关系字段，关联到用户（通过 backref）

## 卡密注册流程说明
1. 管理员在后台创建卡密到 RegisterSecret 表
2. 用户使用卡密进行注册
3. 系统验证卡密是否存在且未使用
4. 验证通过后创建 User 记录
5. 同时将卡密标记为已使用，并设置 user_id 关联
6. 双向关联建立完成，可通过用户查卡密，也可通过卡密查用户

## 使用说明

### 运行 Flask 应用
```powershell
.\venv\Scripts\activate
python run.py
```
访问 `http://localhost:5000`

### 数据库操作
```powershell
# 初始化数据库
.\venv\Scripts\python init_db.py
```

### Tailwind CSS 开发命令
- 一次性编译：`npm run build`
- 监听变化自动编译：`npm run watch`

### 用户认证功能使用
- 登录页面：`http://localhost:5000/auth/login`
- 注册页面：`http://localhost:5000/auth/register`
- 退出登录：`http://localhost:5000/auth/logout`
- 示例用户：admin/admin123（超级管理员）

### 13. 登录注册页面样式美化
- [x] 按照 index.html 风格重新设计登录注册页面
- [x] 使用蓝色渐变背景和白色卡片设计
- [x] 添加图标、渐变标题、圆角按钮
- [x] 登录页面使用蓝色主题，注册页面使用绿色主题
- [x] 统一页面风格，保持移动端适配

### 14. 代码结构重构
- [x] 整合配置和数据库初始化到 app.py
- [x] 删除 config.py 和 extensions.py 文件
- [x] 使用区域备注分隔 app.py 的不同功能区域
- [x] 更新所有模型和路由的 import 语句
- [x] 保持 models、routes、forms 三个主要模块

### 15. 项目目录结构优化
- [x] 创建 app/ 目录，将所有应用文件移动到 app/ 下
- [x] 将原来的 app.py 重构为 app/__init__.py
- [x] 创建 run.py 作为项目启动文件
- [x] 更新所有 import 语句，使用 app. 前缀
- [x] 更新 tailwind.config.js 配置，指向 app/templates 和 app/static
- [x] 更新 init_db.py 的 import 语句
- [x] 测试验证应用可以正常创建和运行

## 数据模型说明

### User 模型字段
- `id`: 主键
- `username`: 用户名（唯一，索引）
- `email`: 邮箱（唯一，索引）
- `password_hash`: 密码哈希
- `is_admin`: 是否为管理员
- `is_super_admin`: 是否为超级管理员
- `created_at`: 创建时间
- `register_secrets`: 关系字段，关联到使用的卡密（一对多）

### RegisterSecret 模型字段
- `id`: 主键
- `secret`: 注册卡密（唯一，索引）
- `is_used`: 是否已使用
- `user_id`: 外键，关联到 User 表
- `created_at`: 创建时间
- `used_at`: 使用时间
- `user`: 关系字段，关联到用户（通过 backref）

## 卡密注册流程说明
1. 管理员在后台创建卡密到 RegisterSecret 表
2. 用户使用卡密进行注册
3. 系统验证卡密是否存在且未使用
4. 验证通过后创建 User 记录
5. 同时将卡密标记为已使用，并设置 user_id 关联
6. 双向关联建立完成，可通过用户查卡密，也可通过卡密查用户

## app.py 结构说明
app.py 按照功能区域使用备注分隔：

### 配置区域
- Config 类：包含 SECRET_KEY、SQLALCHEMY_DATABASE_URI 等配置
- basedir：项目根目录路径

### 扩展初始化
- db = SQLAlchemy()：数据库扩展初始化

### 应用工厂函数
- create_app()：创建 Flask 应用
- 配置数据库初始化
- 配置 LoginManager
- 注册蓝图

### 运行应用
- 主程序入口，启动 Flask 开发服务器

## 技术栈
- **后端框架**: Flask 3.1.3
- **数据库**: SQLite + Flask-SQLAlchemy 3.1.1
- **前端样式**: Tailwind CSS 3.4.0
- **表单验证**: Flask-WTF 1.2.2
- **用户认证**: Flask-Login 0.6.3
- **架构模式**: 工厂模式 + Blueprint
- **开发目标**: 移动端适配应用
