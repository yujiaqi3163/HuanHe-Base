# Flask Web 应用开发文档

## 项目概述
本项目是一个基于 Flask + Tailwind CSS 的 Web 应用，包含用户认证、数据库管理等功能，采用移动端适配设计。

---

## 开发步骤

### 1. 环境准备与 Flask 基础搭建
#### 1.1 安装 Flask 框架
```powershell
# 创建虚拟环境
python -m venv venv
.\venv\Scripts\activate

# 安装 Flask 及相关依赖
pip install flask
pip install flask-sqlalchemy
pip install flask-wtf
pip install flask-login
```

#### 1.2 项目目录结构
```
my_flask_app/
├── app/                          # 应用主目录
│   ├── __init__.py              # 应用配置入口
│   ├── templates/                # HTML 模板目录
│   │   ├── base.html           # 基础模板（所有页面继承）
│   │   ├── main/               # 主页面模板目录
│   │   │   ├── index.html      # 首页模板
│   │   │   └── profile.html    # 个人中心模板
│   │   └── auth/               # 认证相关模板目录
│   │       ├── login.html      # 登录页面模板
│   │       └── register.html   # 注册页面模板
│   ├── static/                   # 静态资源目录
│   │   ├── css/
│   │   │   └── output.css      # Tailwind 编译后的 CSS
│   │   └── src/
│   │       └── input.css       # Tailwind 源文件
│   ├── models/                   # 数据模型目录
│   │   ├── __init__.py
│   │   ├── user.py              # User 用户模型
│   │   ├── register_secret.py   # 注册卡密模型
│   │   ├── material_type.py     # 素材类型模型tag
│   │   ├── material.py          # 素材模型
│   │   └── material_image.py    # 素材图片模型image
│   ├── routes/                   # 路由目录
│   │   ├── __init__.py
│   │   ├── main/
│   │   │   ├── __init__.py
│   │   │   └── routes.py        # 主路由 Blueprint
│   │   └── auth/
│   │       ├── __init__.py
│   │       └── routes.py        # 认证路由
│   └── forms/                    # 表单验证目录
│       ├── __init__.py
│       └── auth.py              # 认证表单
├── run.py                        # 应用启动文件
├── init_db.py                    # 数据库初始化脚本
├── package.json                  # npm 配置文件
├── tailwind.config.js            # Tailwind CSS 配置
└── app.db                        # SQLite 数据库文件
```

---

### 2. Tailwind CSS 配置

#### 2.1 创建 package.json
```json
{
  "name": "my_flask_app",
  "version": "1.0.0",
  "description": "Flask + Tailwind CSS 应用",
  "main": "run.py",
  "scripts": {
    "build": "npx tailwindcss -i ./app/static/src/input.css -o ./app/static/css/output.css",
    "watch": "npx tailwindcss -i ./app/static/src/input.css -o ./app/static/css/output.css --watch"
  },
  "devDependencies": {
    "tailwindcss": "^3.4.0"
  }
}
```

#### 2.2 创建 tailwind.config.js
```javascript
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: ["./app/templates/**/*.{html,js}"],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

#### 2.3 创建 Tailwind 源文件 app/static/src/input.css
```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

#### 2.4 安装并编译 Tailwind
```powershell
npm install
npm run build
```

---

### 3. 数据库配置与模型设计

#### 3.1 User 模型 (app/models/user.py)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | Integer | 主键 | Primary Key |
| username | String(80) | 用户名 | Unique, Index |
| email | String(120) | 邮箱 | Unique, Index |
| password_hash | String(256) | 密码哈希 | |
| is_admin | Boolean | 是否为管理员 | Default: False |
| is_super_admin | Boolean | 是否为超级管理员 | Default: False |
| created_at | DateTime | 创建时间 | Default: utcnow |

**方法：**
- `set_password(password)`: 设置密码（自动加密）
- `check_password(password)`: 验证密码
- `__repr__`: 字符串表示

#### 3.2 RegisterSecret 模型 (app/models/register_secret.py)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | Integer | 主键 | Primary Key |
| secret | String(64) | 注册卡密 | Unique, Index |
| is_used | Boolean | 是否已使用 | Default: False |
| user_id | Integer | 外键，关联 User | Foreign Key |
| created_at | DateTime | 创建时间 | Default: utcnow |
| used_at | DateTime | 使用时间 | Nullable |

**关系：**
- `user`: 反向关联到 User（通过 backref）

#### 3.3 MaterialType 模型 (app/models/material_type.py) - 素材类型
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | Integer | 主键 | Primary Key |
| name | String(50) | 类型名称 | Unique, Index |
| description | String(200) | 类型描述 | Nullable |
| sort_order | Integer | 排序权重 | Default: 0 |
| is_active | Boolean | 是否启用 | Default: True |
| created_at | DateTime | 创建时间 | Default: utcnow |

**关系：**
- `materials`: 与素材的一对多关系

#### 3.4 Material 模型 (app/models/material.py) - 素材主表
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | Integer | 主键 | Primary Key |
| title | String(200) | 素材标题 | Index |
| description | Text | 素材文案 | Nullable |
| material_type_id | Integer | 素材类型ID | Foreign Key |
| view_count | Integer | 浏览次数（热度） | Default: 0 |
| favorite_count | Integer | 收藏次数 | Default: 0 |
| download_count | Integer | 下载次数 | Default: 0 |
| is_published | Boolean | 是否上架 | Default: True |
| sort_order | Integer | 排序权重 | Default: 0 |
| created_at | DateTime | 创建时间 | Default: utcnow |
| updated_at | DateTime | 最后修改时间 | onupdate: utcnow |

**关系：**
- `material_type`: 关联到素材类型
- `images`: 与素材图片的一对多关系（级联删除）

#### 3.5 MaterialImage 模型 (app/models/material_image.py) - 素材图片
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | Integer | 主键 | Primary Key |
| material_id | Integer | 关联的素材ID | Foreign Key |
| image_url | String(500) | 图片URL或路径 | |
| sort_order | Integer | 图片排序 | Default: 0 |
| is_cover | Boolean | 是否为封面图 | Default: False |
| created_at | DateTime | 创建时间 | Default: utcnow |

**关系：**
- `material`: 关联到素材

---

### 4. 应用工厂与配置 (app/__init__.py)
- Config 类：包含 SECRET_KEY、SQLALCHEMY_DATABASE_URI 等配置
- db = SQLAlchemy()：数据库扩展初始化
- create_app()：创建 Flask 应用的工厂函数
- 初始化 LoginManager 用于用户认证
- 注册 main_bp 和 auth_bp 两个 Blueprint

---

### 5. 路由与表单设计

#### 5.1 主路由 (app/routes/main/routes.py)
- `/`: 首页，展示素材列表
- `/profile`: 个人中心页面（需登录）

#### 5.2 认证路由 (app/routes/auth/routes.py)
- `/auth/login`: 登录页面（GET/POST）
- `/auth/register`: 注册页面（GET/POST）
- `/auth/logout`: 退出登录

#### 5.3 表单验证 (app/forms/auth.py)
- **LoginForm**：
  - username_or_email：用户名或邮箱
  - password：密码
  - remember：记住我
  - submit：提交按钮

- **RegisterForm**：
  - username：用户名
  - email：邮箱
  - password：密码
  - password2：确认密码
  - secret：注册卡密
  - submit：提交按钮

---

### 6. 数据库初始化

创建 init_db.py 用于初始化数据库并添加示例数据：

**示例数据：**
- 4 个注册卡密
- 3 个示例用户：
  - admin/admin123（超级管理员）
  - demo/demo123（普通用户）
  - test/test123（普通用户）

初始化命令：
```powershell
.\venv\Scripts\python init_db.py
```

---

### 7. 卡密注册流程
1. 管理员创建卡密到 RegisterSecret 表
2. 用户使用卡密进行注册
3. 系统验证卡密是否存在且未使用
4. 验证通过后创建 User 记录
5. 同时将卡密标记为已使用，并设置 user_id 关联
6. 双向关联建立完成

---

## 使用说明

### 运行 Flask 应用
```powershell
.\venv\Scripts\activate
python run.py
```
访问 `http://localhost:5000`

### Tailwind CSS 开发命令
- 一次性编译：`npm run build`
- 监听变化自动编译：`npm run watch`

### 用户认证功能
- 首页：`http://localhost:5000`
- 登录页面：`http://localhost:5000/auth/login`
- 注册页面：`http://localhost:5000/auth/register`
- 退出登录：`http://localhost:5000/auth/logout`

### 示例账号
| 用户名 | 密码 | 角色 |
|--------|------|------|
| admin | admin123 | 超级管理员 |
| demo | demo123 | 普通用户 |
| test | test123 | 普通用户 |

### 示例卡密
- `SECRET001`（已使用）
- `SECRET002`（未使用）
- `SECRET003`（未使用）
- `SECRET004`（未使用）

---

## 新增功能说明

### 8. 模板继承与基础框架
- 创建 `base.html` 作为基础模板，包含：
  - 顶部搜索栏（个人中心页面可隐藏）
  - 消息闪现区域（支持自动消失）
  - 底部导航栏（首页、分类、发布、库、我的）
  - 消息自动消失脚本（5秒后淡出）
- 其他页面通过 `{% extends "base.html" %}` 继承基础模板

### 9. 页面导航功能
- 首页按钮：跳转到 `/`（首页）
- 我的按钮：跳转到 `/profile`（个人中心）
- 导航栏在 base.html 中统一管理

### 10. 个人中心页面
- 显示当前登录用户的真实用户名和邮箱
- 用户信息卡片、数据看板、功能列表
- 退出登录按钮，绑定 `/auth/logout` 路由
- 个人中心页面隐藏顶部搜索框

### 11. 消息提示优化
- 提示框内容居中显示
- 提示框宽度根据文本自适应
- 5秒后自动消失，带动画效果
- 提示框尺寸优化，减少内容遮挡

### 12. 素材管理模型（新增）
- **MaterialType（素材类型）**：素材分类管理
- **Material（素材主表）**：素材基本信息
  - 标题、文案、类型、浏览次数、收藏次数、下载次数
- **MaterialImage（素材图片）**：素材图片管理
  - 支持多张图片、排序、封面图标记
- 采用一对多关系设计，支持灵活扩展

---

## 技术栈
- **后端框架**: Flask 3.1.3
- **数据库**: SQLite + Flask-SQLAlchemy 3.1.1
- **前端样式**: Tailwind CSS 3.4.0
- **表单验证**: Flask-WTF 1.2.2
- **用户认证**: Flask-Login 0.6.3
- **架构模式**: 工厂模式 + Blueprint
- **设计风格**: 移动端适配

