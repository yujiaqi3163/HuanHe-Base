# 批量上传优化 - 配置说明文档

**最后更新**: 2026-02-22  
**修改内容**: 批量上传安全性和容错性优化

---

## 一、已完成的代码修改

### 1.1 后端修改（Python）

#### 文件：`app/routes/admin/routes.py`

**新增内容**：
- `MAX_FILE_SIZE = 50MB` - 单个文件最大 50MB
- `ALLOWED_EXTENSIONS` - 允许的文件类型白名单
- `ALLOWED_IMAGE_EXTENSIONS` - 图片格式白名单
- `allowed_file()` - 文件扩展名检查函数
- `validate_file()` - 文件验证函数（检查大小和类型）

**修改内容**：
- `batch_upload_material()` - 批量上传API，添加了文件验证逻辑
  - 验证每个图片文件
  - 返回无效文件列表
  - 如果有无效文件，整体拒绝该素材
  - 继续处理下一个素材（前端控制）

#### 文件：`app/__init__.py`

**新增内容**：
- `MAX_CONTENT_LENGTH = 100MB` - Flask 全局请求大小限制

### 1.2 前端修改（JavaScript）

#### 文件：`app/templates/admin/admin_material_add.html`

**优化内容**：
- 已经是逐个文件上传（Loop 方式）
- 增强错误处理：
  - 区分"失败"和"跳过"的素材
  - 显示详细的文件验证失败信息
  - 添加了 webp 和 bmp 格式支持
  - 缩短请求间隔（500ms → 300ms）

---

## 二、Nginx 配置调整（必须）

### 2.1 修改 Nginx 配置

在宝塔面板中，找到网站的 Nginx 配置文件，添加或修改以下配置：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 客户端最大请求体大小（必须配置）
    client_max_body_size 100M;
    
    # 请求体缓冲区大小
    client_body_buffer_size 128k;
    
    # 超时设置
    client_body_timeout 300s;
    client_header_timeout 300s;
    
    # 其他配置...
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 代理超时设置
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
```

### 2.2 关键配置说明

| 配置项 | 值 | 说明 |
|--------|-----|------|
| `client_max_body_size` | 100M | 最大请求体大小（Flask 设的是 100MB） |
| `client_body_timeout` | 300s | 客户端发送请求体超时 |
| `proxy_read_timeout` | 300s | 读取后端响应超时 |

### 2.3 宝塔面板操作步骤

1. 登录宝塔面板
2. 点击左侧「网站」
3. 找到你的网站，点击「设置」
4. 点击「配置文件」标签
5. 在 `server` 块中添加 `client_max_body_size 100M;`
6. 点击「保存」
7. 重启 Nginx（宝塔会自动提示）

---

## 三、Gunicorn 配置调整（推荐）

### 3.1 创建 Gunicorn 配置文件

在项目根目录创建 `gunicorn_config.py`：

```python
import multiprocessing
import os

# 绑定地址
bind = "127.0.0.1:5000"

# Worker 数量（CPU核心数 * 2 + 1）
workers = multiprocessing.cpu_count() * 2 + 1

# Worker 类型
worker_class = "sync"

# 每个 Worker 的线程数
threads = 2

# 最大请求数（防止内存泄漏）
max_requests = 1000
max_requests_jitter = 50

# 超时时间（秒）
timeout = 300
graceful_timeout = 30

# 保持连接时间
keepalive = 5

# 日志配置
accesslog = os.path.join(os.path.dirname(__file__), "logs", "access.log")
errorlog = os.path.join(os.path.dirname(__file__), "logs", "error.log")
loglevel = "info"

# 进程名称
proc_name = "my_flask_app"
```

### 3.2 创建日志目录

```bash
mkdir -p logs
```

### 3.3 启动命令

```bash
# 使用配置文件启动
gunicorn -c gunicorn_config.py app:app
```

### 3.4 宝塔面板 Supervisor 配置

如果使用 Supervisor 管理进程，配置示例：

```ini
[program:my_flask_app]
command=/path/to/venv/bin/gunicorn -c /path/to/project/gunicorn_config.py app:app
directory=/path/to/project
user=www
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/path/to/project/logs/supervisor.log
```

---

## 四、文件大小限制层级

| 层级 | 限制大小 | 位置 | 说明 |
|------|---------|------|------|
| 1️⃣ Nginx | 100MB | Nginx 配置 | 第一道防线 |
| 2️⃣ Flask | 100MB | `app/__init__.py` | 第二道防线 |
| 3️⃣ 业务逻辑 | 50MB | `app/routes/admin/routes.py` | 单个文件 50MB |

**注意**：单个素材可能包含多个图片，所以请求体限制（100MB）要大于单个文件限制（50MB）。

---

## 五、允许的文件类型

### 5.1 图片格式（批量上传素材）

- `.jpg` / `.jpeg`
- `.png`
- `.gif`
- `.webp`（新增）
- `.bmp`（新增）

### 5.2 其他格式（预留）

- `.mp4`
- `.webm`
- `.mov`
- `.avi`
- `.mkv`

---

## 六、容错机制说明

### 6.1 前端容错

- ✅ **逐个上传**：一个素材一个素材地上传，不是一次性全发
- ✅ **失败继续**：某个素材上传失败，继续处理下一个
- ✅ **详细反馈**：显示哪些成功、哪些失败、哪些跳过
- ✅ **跳过无图**：没有图片的文件夹自动跳过

### 6.2 后端容错

- ✅ **文件验证**：检查每个文件的大小和类型
- ✅ **无效反馈**：返回具体哪些文件无效及原因
- ✅ **事务回滚**：单个素材上传失败不影响数据库
- ✅ **日志记录**：所有错误都记录到日志文件

---

## 七、测试清单

部署后请测试以下场景：

- [ ] 上传单个 50MB 图片 → 成功
- [ ] 上传单个 51MB 图片 → 失败，提示大小超限
- [ ] 上传 .exe 文件 → 失败，提示格式不支持
- [ ] 上传包含 10 张图片的素材 → 成功
- [ ] 上传混合有效和无效文件的素材 → 失败，返回无效文件列表
- [ ] 上传 10 个素材，其中 2 个无效 → 8 个成功，2 个失败，详细显示
- [ ] 上传没有图片的文件夹 → 自动跳过

---

## 八、总结

### 必须做的配置

1. ✅ **Nginx**：添加 `client_max_body_size 100M;`
2. ✅ **代码**：已修改完成（Git 提交）

### 推荐做的配置

1. 🟡 **Gunicorn**：使用配置文件启动，设置 `timeout=300`
2. 🟡 **日志目录**：创建 `logs` 目录

### 已完成的优化

- ✅ 前端：逐个上传 + 详细错误反馈
- ✅ 后端：文件大小限制（50MB）+ 类型白名单
- ✅ 安全：多层防护（Nginx → Flask → 业务逻辑）

